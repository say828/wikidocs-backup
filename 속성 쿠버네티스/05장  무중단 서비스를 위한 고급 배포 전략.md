# 05장: 무중단 서비스를 위한 고급 배포 전략

우리는 이제 애플리케이션의 구성을 선언적으로, 그리고 안전하게 관리하는 경지에 이르렀다. GitOps 파이프라인은 우리가 Git에 선언한 '의도'를 한 치의 오차도 없이 클러스터의 현실로 만들어준다. 디플로 '먼트(Deployment)의 롤링 업데이트 기능은 애플리케이션의 새로운 버전을 배포하는 동안 서비스가 중단되지 않도록 지켜주는 든든한 보험처럼 느껴진다.

하지만 정말 그럴까? 당신의 핵심 서비스, 예를 들어 초당 수천 건의 결제를 처리하는 시스템의 버전을 업데이트하는 순간을 상상해보라. 롤링 업데이트가 진행되는 그 몇 초, 혹은 몇 분의 시간 동안 단 하나의 요청이라도 실패하는 것을 용납할 수 있는가? 구버전 파드가 사라지고 신버전 파드가 트래픽을 받기 시작하는 그 아슬아슬한 교체 과정에서, 순간적으로 발생할 수 있는 '보이지 않는' 중단 시간은 비즈니스에 치명적인 손실을 안겨줄 수 있다.

기본적인 롤링 업데이트는 대부분의 상황에서 충분히 훌륭하지만, 진정한 의미의 **무중단(Zero-Downtime)**과 **무결점(flawless)** 릴리즈를 추구하는 아키텍트에게는 결코 최종 목적지가 될 수 없다. 이 장에서는 롤링 업데이트의 숨겨진 함정과 한계를 명확히 파헤치는 것부터 시작한다. 그리고 이를 넘어서기 위해 수십 년간 대규모 시스템 운영을 통해 검증된 고전적이면서도 강력한 배포 전략들, 즉 **블루/그린(Blue/Green)**과 **카나리(Canary)** 배포 아키텍처를 쿠버네티스 환경에서 어떻게 정교하게 구현할 수 있는지 깊이 있게 탐구할 것이다. 마지막으로, 이 모든 고급 전략을 자동화하고 과학적인 근거에 기반하여 릴리즈를 결정하는 궁극의 도구, **Argo Rollouts**를 통해 당신의 배포 파이프라인을 예술의 경지로 끌어올릴 것이다.

---

## 00. 롤링 업데이트의 한계와 진짜 무중단 배포의 의미

쿠버네티스 디플로이먼트가 기본적으로 제공하는 **롤링 업데이트(Rolling Update)** 전략은 매우 직관적이다. 구버전 파드를 점진적으로 줄이는 동시에 신버전 파드를 점진적으로 늘려나가는 방식이다. 이 과정에서 `maxSurge` (업데이트 중 최대로 초과할 수 있는 파드 수)와 `maxUnavailable` (업데이트 중 최대로 사용 불가능할 수 있는 파드 수) 설정을 통해 전체 서비스 용량의 급격한 저하를 막는다. Readiness Probe와 결합하면, 신버전 파드가 완전히 '준비'될 때까지 트래픽이 들어오지 않도록 보호할 수도 있다.

이것만으로도 과거의 '서버 전체를 내리고 올리던' 배포 방식에 비하면 엄청난 발전이다. 하지만 이 방식에는 우리가 간과하기 쉬운 몇 가지 미묘한 함정이 도사리고 있다.

* **양립 불가능한 변경의 문제:** 만약 신버전 애플리케이션이 API 명세를 변경했거나(예: 필수 요청 필드 추가) 데이터베이스 스키마를 변경했다면 어떻게 될까? 롤링 업데이트가 진행되는 동안에는 구버전 파드와 신버전 파드가 **동시에** 트래픽을 처리한다. 이 기간 동안 구버전 클라이언트는 신버전 API를 이해하지 못하고, 신버전 애플리케이션은 구버전 데이터베이스 스키마와 충돌을 일으킬 수 있다. 이는 예측 불가능한 오류의 폭풍을 일으킨다.
* **세션 정합성(Session Affinity) 파괴:** 사용자가 구버전 파드와 통신하며 로그인 세션을 유지하고 있었다고 가정해보자. 로드밸런서의 다음 요청이 갑자기 신버전 파드로 전달되면, 신버전 파드는 해당 세션 정보를 알지 못하므로 사용자는 로그아웃되거나 장바구니가 비워지는 끔찍한 경험을 하게 될 수 있다.
* **느리고 불완전한 롤백:** 롤링 업데이트 도중 심각한 문제를 발견하고 롤백을 결정했다고 해도, 이미 일부 사용자는 신버전의 영향을 받은 상태다. 롤백 과정 역시 또 다른 롤링 업데이트이므로, 시스템이 완전히 안정적인 상태로 돌아오기까지는 상당한 시간이 소요된다. 결정적으로, '언제' 롤백을 해야 하는지를 판단할 명확한 기준을 시스템이 제공해주지 않는다. 오직 운영자의 직감과 모니터링 대시보드를 향한 불안한 눈빛만이 존재할 뿐이다.

**진정한 무중단 배포**란, 단순히 '파드가 떠 있는 상태'를 유지하는 것을 넘어, 업데이트 과정에서 **사용자 경험에 그 어떤 부정적인 영향도 미치지 않는 것**을 의미한다. 여기에는 다음의 약속이 포함되어야 한다.

1.  **연결의 무결성:** 진행 중이던 사용자의 요청(in-flight requests)은 업데이트가 시작되더라도 반드시 안전하게 처리되어야 한다.
2.  **상태의 일관성:** 구버전과 신버전이 공존하는 과도기 상태가 사용자에게 노출되어서는 안 된다. 트래픽은 예측 가능한 방식으로, 일관된 버전의 애플리케이션으로만 흘러가야 한다.
3.  **즉각적인 재해 복구:** 새로운 버전에 문제가 있을 경우, 단 한 번의 조작으로, 거의 즉시, 그리고 100%의 트래픽을 안정적인 이전 버전으로 되돌릴 수 있어야 한다.

롤링 업데이트는 이 모든 약속을 지키기에는 너무 순진한 전략이다. 우리는 이제 트래픽의 흐름을 훨씬 더 정교하고 대담하게 통제할 수 있는, 한 차원 높은 수준의 배포 아키텍처를 탐험할 준비가 되었다. 가장 먼저, 가장 안전한 길을 선택하는 방법인 블루/그린 배포의 세계로 들어가 보자.