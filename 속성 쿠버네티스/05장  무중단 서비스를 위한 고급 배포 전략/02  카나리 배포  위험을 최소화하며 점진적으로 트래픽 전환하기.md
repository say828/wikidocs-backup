## 02. 카나리 배포: 위험을 최소화하며 점진적으로 트래픽 전환하기

블루/그린 배포가 전면전과 같다면, **카나리 배포(Canary Deployment)**는 고도로 훈련된 특수부대를 적진에 먼저 침투시키는 은밀한 작전과 같다. 이 이름은 과거 광부들이 유독 가스를 감지하기 위해 카나리아 새를 먼저 광산에 들여보냈던 위험한 관행에서 유래했다. 만약 카나리아가 노래를 멈추면, 그것은 광부들에게 즉시 대피하라는 경고 신호였다.

소프트웨어 배포의 세계에서, 이 불쌍한 카나리아의 역할은 바로 **'일부 소수의 실제 사용자 그룹'**이 담당한다. 카나리 배포의 핵심 철학은 신버전을 전체 사용자에게 한 번에 공개하는 대신, 1%, 5%와 같은 극히 일부의 트래픽만을 새로운 버전으로 조심스럽게 흘려보내고, 그 반응을 면밀히 관찰하는 것이다. 이 '카나리 그룹'의 사용자들이 아무런 문제 없이 새로운 버전을 사용한다면, 우리는 점차적으로 트래픽의 비중을 늘려나가 최종적으로 100% 전환을 완료한다. 만약 카나리 그룹에서 에러율이 급증하거나, 응답 시간이 현저히 느려지는 등 부정적인 신호가 감지되면, 우리는 즉시 트래픽을 0%로 되돌려 구버전으로 롤백한다.

이 방식의 가장 큰 장점은 **위험의 반경(Blast Radius)**을 극적으로 최소화할 수 있다는 것이다. 신버전에 잠재된 치명적인 버그가 있더라도, 그 영향은 오직 전체 사용자 중 1%에게만 미친다. 나머지 99%의 사용자는 아무런 문제 없이 안정적인 구버전을 계속 사용하게 된다.

카나리 배포는 우리에게 블루/그린 배포가 주지 못하는 또 다른 강력한 무기를 제공한다. 바로 **실제 사용자 데이터에 기반한 의사결정**이다. 우리는 단순히 신버전이 '작동한다'는 사실을 넘어, '더 나은가?'라는 질문에 답을 얻을 수 있다.

* **성능 분석:** 신버전의 평균 응답 시간이나 CPU 사용량이 구버전에 비해 정말로 개선되었는가?
* **비즈니스 메트릭:** 신버전을 사용하는 사용자들이 장바구니에 물건을 더 많이 담거나, 구매 전환율이 더 높은가?
* **에러율 모니터링:** 신버전에서 발생하는 HTTP 500 에러의 비율이 구버전에 비해 유의미하게 높은가?

이처럼 카나리 배포는 배포(Deployment)와 모니터링(Monitoring)을 결합하여, 직감이 아닌 데이터에 근거하여 릴리즈의 성공 여부를 판단하는 과학적인 접근법이다.

그렇다면 이것을 순수한 쿠버네티스 오브젝트만으로 어떻게 흉내 낼 수 있을까? 가장 원시적인 방법은 블루/그린 배포와 유사하게, 구버전(stable)과 신버전(canary)을 위한 두 개의 독립적인 디플로이먼트를 운영하는 것이다.

* **Stable Deployment:** `replicas: 9` 로 설정하여 90%의 파드를 유지한다.
* **Canary Deployment:** `replicas: 1` 로 설정하여 10%의 파드를 신버전으로 유지한다.

그리고 이 두 디플로이먼트 모두 동일한 레이블(예: `app: my-app`)을 가지도록 하여, **하나의 서비스(Service)**가 이 10개의 파드 모두를 엔드포인트로 바라보게 만든다. 쿠버네티스 서비스의 기본 로드 밸런싱은 라운드 로빈(Round-robin) 방식이므로, 이론적으로 전체 요청의 약 10%가 카나리 버전으로 향하게 될 것이다.

[그림: 하나의 서비스가 Stable과 Canary 디플로이먼트 모두를 선택하는 아키텍처]

하지만 이 방식은 지극히 불안정하고 통제하기 어렵다.
* 트래픽의 비율을 파드의 복제본 수에 의존하므로 1%와 같은 세밀한 제어가 불가능하다.
* "내부 테스터에게만 카나리 버전을 노출"과 같은 정교한 라우팅 규칙을 적용할 수 없다.
* 트래픽 비율을 점진적으로 늘려나가는 과정을 완전히 수동으로 관리해야 한다.
* 메트릭을 분석하여 자동으로 롤백을 결정하는 지능적인 로직이 없다.

이러한 한계를 극복하기 위해서는, 우리는 파드의 개수가 아닌 실제 L7 트래픽의 흐름을 직접 제어할 수 있는 더 높은 수준의 도구가 필요하다. 서비스 메시(Service Mesh)인 Istio나 Linkerd, 혹은 Ingress Controller를 활용하여 가중치 기반 라우팅(weighted routing)을 구현할 수도 있지만, 이는 설정의 복잡성을 크게 증가시킨다.

바로 이 지점에서, 이 모든 점진적 배포의 복잡성을 하나의 완성된 솔루션으로 해결해주는 구원자가 등장한다. 블루/그린과 카나리 전략을 완벽하게 자동화하고, 분석하며, 안전하게 실행하기 위해 태어난 프로젝트, **Argo Rollouts**다. 다음 절에서는 이 궁극의 배포 컨트롤러를 통해 우리의 배포 파이프라인을 어떻게 완성할 수 있는지 살펴볼 것이다.