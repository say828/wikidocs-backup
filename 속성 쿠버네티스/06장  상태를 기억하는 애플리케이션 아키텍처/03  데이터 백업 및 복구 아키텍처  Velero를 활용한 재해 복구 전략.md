## 03. 데이터 백업 및 복구 아키텍처: Velero를 활용한 재해 복구 전략

우리는 데이터베이스를 쿠버네티스 위에서 운영하는 것의 막중한 책임에 대해 논했다. 그 책임의 정점에는 바로 **재해 복구(Disaster Recovery)**가 있다. 아무리 고가용성(HA)을 갖춘 클러스터를 설계했다 하더라도, 데이터센터 전체가 마비되는 광역 장애나, 누군가의 실수로 `kubectl delete namespace production`과 같은 치명적인 명령이 실행되는 인적 재난 앞에서는 속수무책이다. 이때 우리의 비즈니스를 구원할 수 있는 유일한 희망은, 이 모든 혼돈과 무관한 안전한 장소에 보관된 **백업**뿐이다.

하지만 쿠버네티스 환경에서의 백업은 전통적인 가상머신(VM) 스냅샷이나 데이터베이스 덤프(dump)와는 그 차원이 다르다. 쿠버네티스 애플리케이션의 '상태'는 단순히 디스크 위에 있는 데이터 바이트의 집합이 아니기 때문이다. 애플리케이션의 완전한 상태란, **영속적 데이터(Persistent Volume)와 그 데이터를 사용하는 모든 쿠버네티스 오브젝트(Deployment, StatefulSet, ConfigMap, Secret 등)의 총합**이다. 데이터베이스 볼륨만 덩그러니 백업해봤자, 그 볼륨을 어떻게 사용해야 하는지에 대한 설계도인 스테이트풀셋 YAML과 접속 정보를 담은 시크릿이 없다면 그것은 무용지물이다.

우리가 필요한 것은 클러스터의 모든 것을 이해하고, 애플리케이션이라는 '논리적 단위' 전체를 통째로 백업하고 복원할 수 있는 쿠버네티스 네이티브(Kubernetes-native) 솔루션이다. 이 분야의 논쟁할 여지 없는 표준이자 최후의 보루가 바로 **Velero**다.

Velero는 단순히 디스크를 복사하는 도구가 아니다. Velero는 클러스터의 API 서버와 직접 대화하여, 당신의 애플리케이션을 구성하는 모든 YAML 명세와 그들이 사용하는 영속 볼륨의 스냅샷을 하나의 일관된 시점으로 묶어, 클러스터 외부의 안전한 **오브젝트 스토리지(Object Storage, 예: AWS S3)**에 보관하는 재해 복구 관제탑이다.

Velero의 백업 및 복구 과정은 다음과 같은 정교한 오케스트레이션으로 이루어진다.

1.  **백업 명령 (`velero backup create ...`):**
    * 사용자가 특정 네임스페이스나 레이블을 지정하여 백업을 요청한다.
    * Velero 서버는 API 서버에 쿼리하여 지정된 범위 내의 모든 쿠버네티스 오브젝트(Deployment, Service, PVC 등)를 JSON/YAML 형태로 가져온다.
    * 이 오브젝트들은 하나의 압축 파일(tar.gz)로 묶여, 지정된 S3 버킷과 같은 오브젝트 스토리지에 업로드된다. 이것이 바로 **'메타데이터 백업'**이다.
    * 동시에, Velero는 백업 대상에 포함된 PVC들을 식별한다. 그리고 각 클라우드 제공업체에 맞는 플러그인(plugin)을 통해, 해당 PVC에 연결된 실제 디스크(예: AWS EBS 볼륨)의 **네이티브 스냅샷**을 생성하도록 클라우드 API를 호출한다.
    * 이 스냅샷의 위치 정보 또한 메타데이터 백업 파일에 함께 기록된다.

2.  **복구 명령 (`velero restore create ...`):**
    * 완전히 새로운 클러스터(혹은 동일 클러스터)에 Velero를 설치하고 이전과 동일한 S3 버킷을 바라보게 설정한다.
    * 사용자가 특정 백업본을 지정하여 복구를 요청한다.
    * Velero는 S3에서 메타데이터 백업 파일을 다운로드하여 압축을 푼다.
    * 먼저, PVC를 제외한 모든 쿠버네티스 오브젝트(Deployment, Service 등)를 새로운 클러스터에 순서대로 다시 생성한다.
    * 그다음, 백업된 PVC 정보를 바탕으로, 이전에 생성해 둔 디스크 스냅샷으로부터 **새로운 영속 디스크를 생성**하도록 클라우드 API를 호출한다.
    * 마지막으로, 이 새로 생성된 디스크를 가리키는 PV와 PVC를 생성하여, 앞서 복원된 파드(예: 스테이트풀셋의 파드)가 마운트할 수 있도록 준비시킨다.

[그림: Velero가 쿠버네티스 API 및 클라우드 스냅샷 API와 연동하여 백업/복구하는 아키텍처]

이 과정을 통해 우리는 단순히 데이터뿐만 아니라, 애플리케이션의 구조, 설정, 네트워크 규칙 등 모든 것을 완벽하게 다른 클러스터에 되살릴 수 있다. Velero는 단순한 백업 툴을 넘어, 다음과 같은 강력한 전략적 가치를 제공한다.

* **진정한 재해 복구:** us-east-1 리전 전체가 다운되더라도, 우리는 S3에 백업된 데이터를 이용해 몇 분 안에 us-west-2 리전의 새로운 클러스터에서 서비스를 재개할 수 있다.
* **클러스터 마이그레이션:** 온프레미스 클러스터에서 클라우드로, 혹은 EKS 1.28에서 1.29로 클러스터를 업그레이드할 때, Velero는 애플리케이션 전체를 안전하게 이주시키는 가장 확실한 방법이다.
* **개발/테스트 환경 복제:** 프로덕션 네임스페이스를 Velero로 백업한 뒤, 개발 클러스터에 복원하여 실제 데이터와 구성을 가진 완벽한 테스트 환경을 즉시 만들어낼 수 있다.

상태 저장 애플리케이션을 쿠버네티스 위에서 운영하겠다는 결심은, Velero와 같은 견고한 재해 복구 전략을 갖추었을 때 비로소 완성된다. 그것은 우리가 짊어진 '데이터에 대한 책임'을 완수하기 위한 마지막 약속이자, 어떤 재난 속에서도 우리의 시스템이 다시 일어설 수 있다는 확신을 주는 기술적인 보험이다.

이제 우리는 상태가 없는 애플리케이션과 상태를 기억하는 애플리케이션 모두를 다룰 수 있는 완전한 무기를 갖추었다. 하지만 우리의 여정은 여기서 멈추지 않는다. 다음 장에서는, 명령형 관리의 함정을 넘어, 우리 플랫폼의 모든 것을 코드로 관리하고 동기화하는 지속 가능한 운영 패러다임의 정점, **GitOps**의 세계로 들어갈 것이다.