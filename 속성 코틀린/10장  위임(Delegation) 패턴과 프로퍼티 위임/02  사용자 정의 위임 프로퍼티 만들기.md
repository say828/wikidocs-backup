### 사용자 정의 위임 프로퍼티 만들기

`lazy`, `observable`, `vetoable`은 매우 유용하지만, 프로퍼티 위임의 진정한 묘미는 우리가 원하는 모든 종류의 동작을 직접 만들 수 있다는 점에 있습니다. 프로퍼티에 값이 할당될 때마다 자동으로 앞뒤 공백을 제거하거나, 값이 변경될 때마다 데이터베이스에 저장하는 등, 상상할 수 있는 거의 모든 공통 로직을 재사용 가능한 대리인(delegate) 클래스로 만들 수 있습니다.

-----

#### 위임 프로퍼티의 약속: `getValue`와 `setValue`

`by` 키워드가 마법처럼 동작하는 이유는 사실 컴파일러가 정해진 \*\*규약(Convention)\*\*을 따르기 때문입니다. 프로퍼티 위임을 하려면, 대리인 클래스는 정해진 시그니처의 `getValue`와 `setValue`(var 프로퍼티의 경우) 함수를 제공해야 합니다. 이 함수들 앞에는 `operator` 키워드를 붙여야 합니다.

##### `val` 프로퍼티를 위한 대리인

읽기 전용 프로퍼티는 값을 읽는 기능만 필요하므로, `getValue` 함수만 구현하면 됩니다.

```kotlin
// operator fun getValue(thisRef: Any?, property: KProperty<*>): T
// thisRef: 프로퍼티를 소유한 객체 (예: UserProfile 객체)
// property: 프로퍼티 자체에 대한 정보 (예: 이름 "profilePhoto")
// 반환값 T: 프로퍼티의 타입
```

##### `var` 프로퍼티를 위한 대리인

변경 가능 프로퍼티는 값을 읽고 쓰는 기능이 모두 필요하므로, `getValue`와 `setValue` 함수를 모두 구현해야 합니다.

```kotlin
// operator fun setValue(thisRef: Any?, property: KProperty<*>, value: T)
// value: 프로퍼티에 할당하려는 새로운 값
```

-----

#### 직접 만들어보기: 문자열 공백 자동 제거 대리인

`String` 타입의 `var` 프로퍼티에 값이 할당될 때마다, 자동으로 문자열의 앞뒤 공백을 제거(`trim()`)해주는 `TrimDelegate`를 만들어 봅시다.

##### 1단계: 대리인 클래스 정의

```kotlin
import kotlin.reflect.KProperty

// String 타입 프로퍼티를 위한 대리인
class TrimDelegate {
    private var actualValue: String = ""

    // 프로퍼티의 값을 읽을 때 호출됨
    operator fun getValue(thisRef: Any?, property: KProperty<*>): String {
        return actualValue
    }

    // 프로퍼티에 새로운 값을 할당할 때 호출됨
    operator fun setValue(thisRef: Any?, property: KProperty<*>, value: String) {
        // 핵심 로직: 할당하려는 값의 공백을 제거하여 저장
        actualValue = value.trim()
    }
}
```

##### 2단계: 대리인 사용하기

이제 이 `TrimDelegate`를 실제 클래스의 프로퍼티에 `by` 키워드로 연결해 주기만 하면 됩니다.

```kotlin
class Post(title: String) {
    // title 프로퍼티는 생성자에서 바로 초기화
    val title: String = title.trim()
    
    // content 프로퍼티의 getter/setter는 TrimDelegate에게 위임
    var content: String by TrimDelegate()
}
```

`Post` 클래스 자체에는 공백 제거와 관련된 코드가 전혀 없습니다. 모든 책임과 로직은 `TrimDelegate`가 가져갑니다.

##### 3단계: 동작 확인

```kotlin
fun main() {
    val post = Post("  코틀린 위임 프로퍼티  ")
    
    // content에 공백이 포함된 문자열을 할당
    post.content = "    이것은 매우 유용한 기능입니다.   "
    
    println("제목: [${post.title}]")
    // 출력: 제목: [코틀린 위임 프로퍼티]

    println("내용: [${post.content}]")
    // 출력: 내용: [이것은 매우 유용한 기능입니다.]
    // TrimDelegate의 setValue가 호출되어 공백이 제거된 채로 저장되었음을 알 수 있습니다.
}
```

이처럼 사용자 정의 위임 프로퍼티를 사용하면, 검증, 포매팅, 로깅, 캐싱 등 프로퍼티와 관련된 부가적인 로직들을 비즈니스 로직이 담긴 메인 클래스로부터 완벽하게 분리할 수 있습니다. 이는 코드의 재사용성을 높이고, 각 클래스가 단 하나의 책임만 갖도록 하는 좋은 설계 원칙을 지키는 데 큰 도움을 줍니다.