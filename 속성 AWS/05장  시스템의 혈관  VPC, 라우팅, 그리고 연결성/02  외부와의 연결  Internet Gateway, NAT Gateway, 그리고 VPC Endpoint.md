## 02. 외부와의 연결: Internet Gateway, NAT Gateway, 그리고 VPC Endpoint

우리의 VPC라는 데이터 센터는 이제 내부에 정교한 도로망(서브넷)과 교통 규칙(라우팅 테이블, 보안 그룹)을 갖추었다. 하지만 이 데이터 센터가 외부 세계와 완전히 단절된 섬으로 존재한다면 아무런 가치를 창출할 수 없다. 고객의 요청을 받아들이고, 외부 서비스와 연동하며, AWS의 다른 관리형 서비스들을 활용하기 위해서는 반드시 외부와의 **연결 통로**, 즉 **게이트웨이(Gateway)**가 필요하다.

VPC의 게이트웨이는 우리 데이터 센터의 목적과 보안 수준에 따라 각기 다른 역할을 수행하는 여러 종류의 '문'에 비유할 수 있다. 모든 사람과 화물이 드나드는 정문이 있는가 하면, 내부 직원만 밖으로 나갈 수 있는 쪽문, 그리고 외부 도로를 거치지 않고 옆 건물로 바로 연결되는 비밀 통로도 있다. 이 문들을 어떻게 설치하고 관리하느냐에 따라 우리 시스템의 보안과 효율성이 결정된다.

### 인터넷 게이트웨이 (Internet Gateway): 양방향 고속도로 입구

**인터넷 게이트웨이(IGW)**는 VPC가 외부 인터넷과 통신하기 위한 가장 기본적인 관문이다. 이것은 VPC에 연결되는 가상의 라우터로, 퍼블릭 IP 주소를 가진 리소스가 인터넷과 양방향으로 트래픽을 주고받을 수 있게 해준다.



* **역할:** IGW는 두 가지 핵심적인 변환 작업을 수행한다. 첫째, VPC 내부의 프라이빗 IP 주소를 인터넷에서 통용되는 공인 IP 주소로 변환(Network Address Translation, NAT)해준다. 둘째, VPC 외부로 향하는 트래픽과 외부에서 VPC로 들어오는 트래픽을 라우팅한다.
* **연결 대상:** **퍼블릭 서브넷**의 라우팅 테이블은 외부로 향하는 모든 트래픽(`0.0.0.0/0`)의 목적지를 바로 이 인터넷 게이트웨이로 지정한다. 이 규칙이 없다면, 퍼블릭 서브넷의 EC2 인스턴스에 공인 IP를 할당하더라도 인터넷과 통신하는 것은 불가능하다.
* **핵심:** IGW는 **양방향(Bi-directional)** 통신을 위한 문이다. 즉, 내부에서 외부로 나가는 것(Outbound)과 외부에서 내부로 들어오는 것(Inbound)이 모두 가능하다. 'NextGen Commerce'의 웹 서버가 사용자의 HTTP 요청을 받아들이는 것은 바로 이 IGW를 통해서다.

### NAT 게이트웨이 (NAT Gateway): 보안 검색대가 있는 출구 전용문

우리의 데이터베이스나 핵심 비즈니스 로직을 처리하는 WAS는 **프라이빗 서브넷**에 위치하여 외부의 직접적인 접근으로부터 보호받아야 한다. 하지만 이 서버들도 OS 보안 패치를 다운로드하거나, 외부 결제 서비스의 API를 호출하는 것처럼 외부 인터넷으로 '나가야' 할 필요는 있다. 그렇다고 이들을 퍼블릭 서브넷에 배치하거나 인터넷 게이트웨이로 직접 연결하는 것은 보안 상 최악의 선택이다.

이 딜레마를 해결하는 것이 바로 **NAT(Network Address Translation) 게이트웨이**다. NAT 게이트웨이는 프라이빗 서브넷에 위치한 리소스들이 외부 인터넷으로 나가는 **단방향(Uni-directional) 아웃바운드 연결**을 가능하게 해주는 AWS의 완전 관리형 서비스다.



* **작동 원리:** 프라이빗 서브넷의 인스턴스가 외부로 통신을 시작하면, 라우팅 테이블은 이 트래픽을 **퍼블릭 서브넷에 위치한 NAT 게이트웨이**로 보낸다. NAT 게이트웨이는 자신의 공인 IP 주소를 사용하여 트래픽을 인터넷 게이트웨이를 통해 외부로 내보낸다. 외부 서비스로부터의 응답은 NAT 게이트웨이를 거쳐 원래 요청을 보냈던 프라이빗 인스턴스로 안전하게 전달된다.
* **핵심:** NAT 게이트웨이는 외부에서 먼저 연결을 시작하는 인바운드 트래픽은 원천적으로 차단한다. 오직 내부에서 시작된 요청에 대한 '응답'만 안으로 들여보내 준다. 이는 마치 보안 검색대가 있는 출구 전용문과 같아서, 안에서는 밖으로 나갈 수 있지만 밖에서는 안으로 들어올 수 없는 구조다. 이를 통해 우리는 핵심 자산의 보안을 유지하면서도 필요한 외부 통신을 수행할 수 있다.

### VPC 엔드포인트 (VPC Endpoint): AWS 서비스로 가는 비밀 통로

우리의 애플리케이션은 S3, SQS, DynamoDB와 같은 수많은 AWS 관리형 서비스들과 상호작용해야 한다. 전통적으로 이러한 통신은 인터넷 게이트웨이나 NAT 게이트웨이를 거쳐, 즉 **퍼블릭 인터넷**을 통해 이루어졌다. 이는 데이터가 우리의 VPC를 벗어나 공용 네트워크를 한 바퀴 돌고 다시 AWS 서비스로 들어가는 것을 의미한다. 이는 불필요한 네트워크 지연을 유발할 뿐만 아니라, 데이터가 공용망에 노출될 수 있다는 잠재적인 보안 위험을 내포한다.

**VPC 엔드포인트**는 이러한 비효율과 위험을 제거하기 위한 가장 우아한 해결책이다. VPC 엔드포인트는 S3나 DynamoDB와 같은 AWS 서비스에 대해, 인터넷을 거치지 않고 AWS의 내부 네트워크망을 통해 **사적이고(Private) 안전하게** 연결할 수 있는 가상의 통로를 만들어준다.



VPC 엔드포인트에는 두 가지 주요 유형이 있다.
1.  **게이트웨이 엔드포인트 (Gateway Endpoint):** S3와 DynamoDB를 위해 사용된다. 라우팅 테이블에 특정 AWS 서비스(예: S3)로 향하는 경로를 엔드포인트를 통해 직접 연결하는 방식으로 작동한다. 이는 추가 비용 없이 사용할 수 있는 매우 효율적인 방법이다.
2.  **인터페이스 엔드포인트 (Interface Endpoint):** 게이트웨이 엔드포인트가 지원하지 않는 대부분의 다른 AWS 서비스(SQS, Kinesis, Secrets Manager 등)에 사용된다. 이 엔드포인트는 VPC 서브넷 내에 프라이빗 IP 주소를 가진 가상의 네트워크 인터페이스(ENI)를 생성한다. 우리의 애플리케이션은 이 프라이빗 IP 주소로 통신함으로써, 마치 같은 VPC 내의 다른 리소스와 통신하는 것처럼 안전하고 빠르게 AWS 서비스를 이용할 수 있다.

'NextGen Commerce'의 WAS(프라이빗 서브넷)가 S3 버킷에 저장된 상품 이미지를 처리해야 할 때, VPC 엔드포인트를 사용하면 민감한 데이터가 인터넷에 노출될 위험 없이, 더 낮은 지연 시간과 더 높은 보안 수준으로 작업을 수행할 수 있다. 이는 비용을 절감(NAT 게이트웨이 데이터 처리 비용 없음)하고 Well-Architected의 보안 및 성능 효율성 원칙을 동시에 만족시키는 최적의 설계다.

결론적으로, 외부와의 연결성은 무작정 열어두는 것이 아니라, **목적에 따라 철저히 통제**되어야 한다. 불특정 다수를 위한 문(IGW), 내부 직원을 위한 문(NAT GW), 그리고 파트너사를 위한 비밀 통로(VPC Endpoint)를 명확히 구분하고 관리하는 것이 안전하고 효율적인 데이터 센터를 만드는 핵심이다. 이제 우리는 이 혈관 시스템을 망가뜨릴 수 있는 가장 흔한 실수, 즉 안티패턴에 대해 살펴볼 것이다.