# 부록 B: 반드시 피해야 할 AWS 아키텍처 안티패턴

이 책은 최고의 아키텍처를 구축하는 '해야 할 일(Do's)'에 대해 이야기했다. 하지만 때로는 '하지 말아야 할 일(Don'ts)'을 아는 것이 더 중요하다. 안티패턴(Anti-pattern)이란, 문제에 대한 흔한 해결책처럼 보이지만 실제로는 더 심각한 문제를 야기하는 나쁜 습관이나 설계를 의미한다.

이 부록에서는 지난 수십 년간 수많은 클라우드 프로젝트 현장에서 목격했던, 가장 치명적이고 반복적으로 나타나는 아키텍처 안티패턴들을 박제했다. 이 함정들을 피하는 것만으로도, 당신의 아키텍처는 상위 10%의 안정성과 보안을 확보하게 될 것이다.

---

## 00. 보안 그룹(Security Group)을 0.0.0.0/0으로 열어두기

이것은 클라우드 보안에서 가장 흔하게 저지르는 첫 번째 죄악이자, 모든 재앙의 시작이다. 개발의 편의성을 위해, 혹은 잠시 테스트를 위해 SSH(22), RDP(3389), 데이터베이스(3306, 5432)와 같은 관리 포트를 `0.0.0.0/0` (인터넷상의 모든 IP)에 대해 열어두는 행위다.

* **왜 죄악인가:** 이는 당신의 서버로 들어오는 현관문에 자물쇠를 제거하고 "누구나 들어오세요"라는 팻말을 걸어둔 것과 같다. 당신이 이 규칙을 저장하는 순간, 전 세계의 자동화된 스캐닝 봇은 수 분 내에 이 열린 포트를 발견하고 무차별 대입 공격을 시작한다. 이것은 가정이 아닌 현실이다. "복잡한 비밀번호를 쓰니까 괜찮아"라는 믿음은 곧 깨지게 될 것이다.

* **올바른 처방전:**
    * **관리 포트 (SSH, RDP):** 절대로 `0.0.0.0/0`을 사용해서는 안 된다. 반드시 당신의 사무실이나 집의 고정 IP 주소(`My IP`), 혹은 회사의 VPN IP 대역으로 소스를 제한해야 한다. 가장 이상적인 클라우드 네이티브 방식은 **AWS Systems Manager Session Manager**를 사용하는 것이다. 이 방법은 SSH 포트 자체를 열 필요 없이 IAM 권한만으로 인스턴스에 안전하게 접속할 수 있게 해준다.
    * **웹 트래픽 (HTTP/S):** `0.0.0.0/0`은 오직 **Application Load Balancer** 또는 **CloudFront**와 같이 사용자 트래픽의 진입점이 되는 리소스에만, 그것도 80/443 포트에 한해서만 허용되어야 한다. 실제 EC2 인스턴스의 보안 그룹은 오직 이 로드 밸런서의 보안 그룹으로부터 오는 트래픽만을 허용하도록 설정하여 인터넷에 직접 노출되는 것을 막아야 한다.

---

## 01. 모든 것을 한 VPC에 담기

비즈니스가 성장함에 따라 개발(dev), 스테이징(staging), 프로덕션(production) 환경이 필요해지고, 여러 다른 팀이 각자의 서비스를 개발하게 된다. 이때 비용을 아끼거나 관리가 귀찮다는 이유로, 이 모든 환경과 서비스를 거대한 단 하나의 VPC 안에 뒤섞어 놓는 경우가 있다.

* **왜 죄악인가:** 이는 마치 중요한 기밀 서류를 보관하는 사무실, 손님을 맞는 응접실, 그리고 직원들이 쉬는 휴게실을 아무런 칸막이 없이 하나의 거대한 방에 몰아넣는 것과 같다.
    * **보안 경계의 부재:** 개발 환경의 취약점을 통해 침투한 공격자가 아무런 제약 없이 프로덕션 데이터베이스로 이동(Lateral Movement)할 수 있는 고속도로를 깔아주는 셈이다.
    * **장애 영향 범위의 확대:** 개발 환경에서 잘못된 네트워크 설정을 변경한 것이 프로덕션 서비스의 통신을 마비시킬 수 있다.
    * **IP 주소 고갈 및 관리의 복잡성:** 모든 리소스가 하나의 IP 대역을 공유하므로 금세 IP 주소가 고갈될 수 있으며, 수백 개의 보안 그룹과 라우팅 테이블이 뒤엉켜 관리가 불가능해진다.

* **올바른 처방전:**
    * **환경별 계정 및 VPC 분리:** AWS Organizations를 사용하여 **개발, 스테이징, 프로덕션 환경을 위한 AWS 계정 자체를 분리**하는 것이 가장 이상적인 모범 사례다. 이는 비용, 보안, 리소스의 완벽한 격리를 제공한다.
    * **VPC Peering 및 Transit Gateway:** 계정이 분리된 VPC 간에 통신이 필요할 경우, VPC Peering이나 중앙 집중식 네트워크 허브 역할을 하는 AWS Transit Gateway를 사용하여 안전하고 관리 가능한 방식으로 연결해야 한다.

---

## 02. IAM User의 Access Key를 코드에 하드코딩하기

애플리케이션이 S3나 DynamoDB와 같은 AWS 서비스에 접근하기 위해, IAM 사용자를 생성하고 그 사용자의 **액세스 키(Access Key ID와 Secret Access Key)**를 발급받아 소스 코드나 설정 파일, 혹은 EC2 인스턴스의 환경 변수에 직접 저장하는 방식이다.

* **왜 죄악인가:** 이것은 당신 집의 마스터키를 복사해서 현관문 앞 화분 밑에 숨겨두는 것과 같다. 이 코드가 실수로 공개된 GitHub 리포지토리에 올라가는 순간, 악의적인 봇이 수 초 내에 이 키를 스캔하여 탈취해간다. 공격자는 이 키를 사용하여 당신의 계정에서 수천 대의 비트코인 채굴용 서버를 실행시킬 것이고, 당신은 다음 날 아침 수천만 원의 요금 폭탄을 맞이하게 될 것이다. 장기 자격 증명(Long-term credentials)인 액세스 키는 일단 유출되면 무효화시키기 전까지 계속해서 악용될 수 있다.

* **올바른 처방전:**
    * **IAM 역할 (IAM Roles) 사용:** AWS 리소스(EC2, ECS, Lambda 등)에서 실행되는 애플리케이션에는 **절대로** IAM 사용자의 액세스 키를 사용해서는 안 된다. 반드시 해당 리소스를 위한 **IAM 역할**을 생성하고, 그 역할에 최소한의 권한을 부여한 뒤, 리소스에 역할을 할당해야 한다. 리소스는 자동으로 갱신되는 임시 보안 자격 증명을 사용하여 안전하게 AWS API를 호출하게 된다.
    * **로컬 개발 환경:** 개발자의 로컬 컴퓨터에서는 AWS CLI의 `aws configure`를 통해 자격 증명을 안전한 위치에 저장하고, 코드에서는 AWS SDK가 자동으로 이 자격 증명을 사용하도록 해야 한다.

---

## 03. 단일 AZ(가용 영역)에 모든 리소스 배포하기

비용을 절감하거나, 혹은 단순히 귀찮다는 이유로 VPC의 서브넷을 생성하고 모든 리소스(EC2, RDS 등)를 단 하나의 가용 영역(예: `ap-northeast-2a`)에만 배치하는 것이다.

* **왜 죄악인가:** 이것은 당신의 모든 비즈니스 자산을 단 하나의 바구니에 담는 행위다. 9장에서 강조했듯이, 가용 영역은 정전, 네트워크 장애, 홍수 등 물리적인 재해로부터 격리되도록 설계되었다. 만약 당신이 선택한 바로 그 AZ에 재해가 발생한다면, 당신의 애플리케이션 전체는 예고 없이, 그리고 완전히 중단될 것이다. 이는 안정성(Reliability) 원칙을 정면으로 위배하는, 가장 기본적인 실수 중 하나다.

* **올바른 처방전:**
    * **모든 계층의 다중 AZ(Multi-AZ) 설계:** 프로덕션 워크로드는 반드시 최소 **두 개 이상의 가용 영역**에 걸쳐 리소스를 분산 배치해야 한다.
        * **로드 밸런서와 Auto Scaling Group**을 여러 AZ에 걸쳐 구성한다.
        * **RDS, ElastiCache**와 같은 관리형 서비스의 다중 AZ 옵션을 반드시 활성화한다.
        * **S3, DynamoDB**와 같은 리전 서비스는 기본적으로 여러 AZ에 데이터를 자동 복제하므로 이러한 위험에서 비교적 자유롭다.

---

## 04. 백업 및 재해 복구 계획 부재

"우리 시스템은 다중 AZ로 구성되어 있으니 안전해."라고 생각하며, 데이터 백업과 재해 복구(Disaster Recovery, DR) 계획을 수립하고 테스트하는 것을 소홀히 하는 것이다.

* **왜 죄악인가:** 다중 AZ는 하드웨어 장애나 AZ 수준의 재해로부터 시스템의 **가용성(Availability)**을 보호해주지만, 인간의 실수나 악의적인 공격으로 인한 **데이터 손상(Data Corruption)**이나 **데이터 유실(Data Loss)**로부터는 당신을 지켜주지 못한다. 개발자가 실수로 `DELETE` 쿼리를 `WHERE` 절 없이 실행하거나, 랜섬웨어 공격으로 데이터베이스 전체가 암호화되는 상황을 상상해 보라. 이 변경 사항은 당신의 다중 AZ 복제본에도 순식간에 복제되어 모든 데이터를 오염시킬 것이다.

* **올바른 처방전:**
    * **자동화된 정기 백업:** **AWS Backup**과 같은 서비스를 사용하여 모든 중요한 데이터 스토어(EBS, RDS, DynamoDB 등)에 대한 자동화된 정기 백업 정책을 수립하고 중앙에서 관리해야 한다.
    * **특정 시점 복구 (Point-in-Time Recovery, PITR):** RDS나 DynamoDB의 PITR 기능을 활성화하여, 장애가 발생하기 직전의 특정 초 단위 시점으로 데이터를 되돌릴 수 있는 능력을 확보해야 한다.
    * **정기적인 복구 훈련:** 백업 파일은 **실제로 복구 테스트를 해보기 전까지는** 그 유효성을 신뢰할 수 없다. 정기적으로(최소 분기별) 백업에서 데이터를 복구하여 별도의 환경에 시스템을 재구성하는 훈련을 통해, 실제 재해 발생 시 당황하지 않고 복구 프로세스를 수행할 수 있음을 검증해야 한다.
    * **다중 리전 DR 전략:** 비즈니스의 RTO/RPO 요구사항에 따라, 백업 데이터를 다른 AWS 리전으로 교차 복제하여 리전 전체에 재해가 발생하는 최악의 시나리오에 대비하는 전략을 고려해야 한다.