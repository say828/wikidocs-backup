## 01. SQS: 신뢰성 있는 비동기 작업을 위한 대기열

비동기 통신의 세계로 들어서는 첫 번째 관문은 가장 단순하면서도 가장 강력한 구성 요소인 **대기열(Queue)**을 이해하는 것이다. 대기열은 생산자(Producer)가 보낸 메시지를 소비자(Consumer)가 처리할 때까지 안전하게 보관하는 중간 저장소다. 이는 마치 붐비는 은행 창구의 번호표 시스템과 같다. 고객(메시지)은 도착하는 대로 번호표(메시지 ID)를 받고 대기 공간(큐)에서 기다린다. 창구 직원(소비자)은 자신의 처리 속도에 맞춰 순서대로 고객을 호출하여 업무를 처리한다. 이 간단한 시스템 덕분에, 창구 직원이 잠시 자리를 비우거나(소비자 장애), 갑자기 고객이 몰려들어도(트래픽 급증), 전체 은행 업무(시스템)는 마비되지 않는다.

**Amazon SQS(Simple Queue Service)**는 이러한 대기열 시스템을 완전 관리형으로 제공하는 AWS의 원조 서비스 중 하나다. SQS의 핵심 철학은 **신뢰성(Reliability)**과 **내구성(Durability)**이다. 일단 메시지가 SQS 큐에 성공적으로 저장되면, AWS는 여러 가용 영역에 걸쳐 데이터를 복제하여 메시지가 절대 유실되지 않음을 보장한다.

### SQS의 작동 방식과 핵심 개념

SQS의 워크플로우는 지극히 단순하고 명확하다.



1.  **생산자(Producer)**는 처리해야 할 작업의 내용이 담긴 **메시지**를 SQS **큐(Queue)**로 보낸다 (SendMessage API).
2.  **소비자(Consumer)**는 큐에 새로운 메시지가 있는지 주기적으로 확인(폴링, Polling)하고, 메시지가 있으면 가져와서(ReceiveMessage API) 처리를 시작한다.
3.  메시지를 가져가는 순간, 그 메시지는 다른 소비자들이 볼 수 없도록 **'처리 중(In-flight)'** 상태가 된다. 이를 **가시성 제한 시간(Visibility Timeout)**이라고 부른다. 이는 동일한 메시지를 여러 소비자가 중복해서 처리하는 것을 방지하는 핵심 메커니즘이다.
4.  소비자는 메시지 처리를 성공적으로 완료한 후, 큐에게 "이 작업은 끝났으니 완전히 삭제해도 좋다"고 알려준다 (DeleteMessage API).
5.  만약 소비자가 가시성 제한 시간 내에 작업을 끝내지 못하거나, 처리 도중 장애가 발생하여 삭제 신호를 보내지 못하면, SQS는 이 메시지가 제대로 처리되지 않았다고 판단하고 다시 큐에 나타나 다른 소비자가 처리할 수 있도록 만든다.

### SQS가 빛을 발하는 시나리오

'NextGen Commerce' 플랫폼에서 SQS는 다양한 백그라운드 작업을 안정적으로 처리하는 데 완벽한 도구다.

* **이미지 처리:** 사용자가 상품 이미지를 업로드하면, 웹 서버는 원본 이미지를 S3에 저장하고, 이미지 처리 작업(리사이징, 워터마크 추가 등)의 내용이 담긴 메시지를 SQS 큐에 넣는다. 이미지 처리 서버(EC2 또는 Lambda)는 자신의 페이스에 맞춰 큐에서 작업을 가져와 처리한다. 이미지 처리가 오래 걸리더라도, 사용자는 업로드 직후 빠른 응답을 받을 수 있다.
* **주문 정산 배치 작업:** 매일 밤 자정에 실행되어야 하는 주문 정산 및 재무 리포트 생성과 같은 무거운 배치(Batch) 작업을 SQS를 통해 비동기적으로 처리할 수 있다.
* **외부 API 호출:** 응답이 느리거나 불안정한 외부 서비스(예: 배송 추적 API)를 호출해야 할 때, 요청 내용을 SQS에 넣고 별도의 워커(Worker)가 안정적으로 재시도 로직을 포함하여 처리하도록 위임할 수 있다.

### 표준 큐 vs FIFO 큐

SQS는 두 가지 유형의 큐를 제공하며, 워크로드의 특성에 따라 신중하게 선택해야 한다.

1.  **표준 큐 (Standard Queue):**
    * **특징:** **최대 처리량(At-Least-Once Delivery)**과 **최고의 성능**을 목표로 설계되었다. 메시지의 순서는 엄격하게 보장되지 않을 수 있으며, 매우 드물게 동일한 메시지가 두 번 이상 전달될 수 있다.
    * **적합한 경우:** 각 메시지가 독립적이라 처리 순서가 중요하지 않고, 만약 중복 처리가 발생하더라도 애플리케이션 로직에서 멱등성(Idempotency)을 통해 안전하게 처리할 수 있는 대부분의 비동기 작업에 적합하다. (예: 이미지 리사이징)

2.  **FIFO (First-In, First-Out) 큐:**
    * **특징:** 이름 그대로, 메시지가 큐에 들어온 **순서를 정확하게 보장**하고, **정확히 한 번만(Exactly-Once Processing)** 전달되도록 설계되었다.
    * **적합한 경우:** 작업의 순서가 비즈니스 로직에 매우 중요한 경우에 사용해야 한다. (예: 사용자의 채팅 메시지, 주식 거래 주문). 순서와 중복 방지를 보장하는 대신, 표준 큐에 비해 초당 처리할 수 있는 트랜잭션 수(TPS)에 제한이 있다.

SQS는 일대일(Point-to-Point) 비동기 통신, 즉 하나의 생산자가 보낸 메시지를 하나의 소비자가 처리하는 시나리오를 위한 가장 신뢰할 수 있는 접착제다. 하지만 만약 하나의 메시지를 여러 다른 서비스가 각자의 목적에 맞게 동시에 처리해야 한다면 어떻게 해야 할까? 이때 필요한 것이 바로 방송(Broadcast) 메커니즘이며, 다음 절에서 다룰 SNS가 그 역할을 수행한다.