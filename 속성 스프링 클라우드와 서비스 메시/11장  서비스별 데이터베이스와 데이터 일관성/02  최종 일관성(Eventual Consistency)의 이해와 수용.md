## 최종 일관성(Eventual Consistency)의 이해와 수용

서비스별로 데이터베이스를 분리하는 순간, 우리는 모놀리스 시절의 가장 큰 위안이었던 **'강력한 즉시적 일관성(Strong Immediate Consistency)'**을 잃게 됩니다. 모든 데이터를 포괄하는 단일 ACID 트랜잭션이 불가능하기 때문입니다.

`product-service`에서 상품의 가격이 10,000원에서 9,500원으로 변경되었다고 가정해 봅시다. 이 변경 사항이 `order-service`가 관리하는 '주문 내역 조회' 읽기 모델에 즉시 반영될 수 있을까요? 정답은 '아니오'입니다. 두 데이터베이스 간의 동기화에는 물리적인 시간(Replication Lag)이 걸리기 때문입니다.

이것이 분산 시스템이 반드시 마주하고 '수용'해야 하는 개념, 바로 **최종 일관성(Eventual Consistency)**입니다.

---

### 최종 일관성이란 무엇인가?

**최종 일관성**은 분산 시스템의 일관성 모델 중 하나로, 다음과 같이 정의됩니다.

> "시스템에 더 이상 새로운 변경 사항이 발생하지 않는다면, **결국(Eventually)** 모든 노드(서비스)의 데이터는 **최종적으로 일관된 상태**로 수렴될 것이다."

쉽게 말해, 시스템의 여러 부분 간에 일시적으로 데이터가 일치하지 않는 상태가 존재할 수 있지만, 시간이 지나면 결국에는 모두 같아진다는 것을 보장하는 모델입니다.

**단체 메시지 비유 💬:**
1.  당신(`쓰기 모델`)이 단체 채팅방에 "오늘 저녁 7시 강남역에서 만나요"라고 메시지를 보냅니다. 당신의 폰에는 즉시 '전송 완료'라고 표시됩니다.
2.  A 친구는 즉시 메시지를 수신합니다.
3.  B 친구는 지하철 터널에 있어 30초 뒤에 메시지를 수신합니다.
4.  C 친구는 폰이 꺼져있어 10분 뒤에 메시지를 수신합니다.

짧은 시간 동안, 약속 장소에 대한 정보는 그룹 멤버들 사이에 **'불일치'** 상태에 있습니다. 하지만 **결국에는** 모든 멤버가 "저녁 7시, 강남역"이라는 동일한 최종 정보에 도달하게 됩니다.

---

### 왜 최종 일관성을 '수용'해야 하는가? (CAP 이론)

최종 일관성은 버그나 잘못된 설계가 아니라, **가용성(Availability)과 성능을 위한 의도적인 아키텍처적 선택**입니다. 이는 CAP 이론과 깊은 관련이 있습니다.



* **CAP 이론:** 분산 시스템은 일관성(C), 가용성(A), 분할 허용성(P) 중 최대 2가지만을 동시에 만족시킬 수 있습니다.
* MSA와 같은 분산 시스템에서 네트워크 단절(P)은 피할 수 없는 현실이므로, 우리는 **C와 A 사이에서 반드시 선택**을 해야 합니다.
* **2PC (강력한 일관성 선택):** 모든 서비스의 데이터가 100% 일치해야만 응답을 주므로 **일관성(C)을 선택**하고, 하나의 서비스라도 응답이 없으면 전체 시스템이 멈추므로 **가용성(A)을 희생**합니다.
* **SAGA/EDA (최종 일관성 선택):** 각 서비스는 자신의 일을 먼저 처리하고(멈추지 않음), 데이터는 나중에 동기화되도록 허용합니다. 즉, **가용성(A)을 선택**하고 **강력한 일관성(C)을 희생**합니다.

대부분의 웹 기반 이커머스 애플리케이션에서는, 사용자가 1초 미만의 데이터 불일치를 겪는 것보다 **서비스가 멈추지 않고 항상 사용 가능한 것**이 비즈니스적으로 훨씬 더 중요합니다.

---

### 이커머스에서 수용 가능한 불일치의 예

* **상품 이름 변경:** 판매자가 상품명을 "멋진 티셔츠"에서 "더 멋진 티셔츠"로 변경했습니다. 사용자의 주문 내역 페이지에는 몇 초간 이전 이름인 "멋진 티셔츠"가 보일 수 있습니다. **괜찮습니다.**
* **리뷰 평점 갱신:** 새로운 5점짜리 리뷰가 등록되었을 때, 상품 목록 페이지의 평균 평점이 갱신되는 데 몇 초가 걸릴 수 있습니다. **괜찮습니다.**

물론, 모든 곳에서 최종 일관성이 허용되는 것은 아닙니다. `product-service` 내부의 '재고 차감' 로직이나 `payment-service`의 '결제 처리' 로직처럼, **단일 서비스(Bounded Context) 내부의 핵심 트랜잭션은 반드시 강력한 일관성(ACID)을 유지해야 합니다.**

**결론적으로,** 일관성은 서비스 **'내부'**에서 강력하게 보장하고, 서비스 **'사이'**에서는 최종 일관성을 수용하는 것이 현대적인 MSA의 데이터 관리 전략입니다.

다음 절에서는 이 최종 일관성을 달성하기 위한 구체적인 데이터 동기화 패턴들을 살펴보겠습니다.