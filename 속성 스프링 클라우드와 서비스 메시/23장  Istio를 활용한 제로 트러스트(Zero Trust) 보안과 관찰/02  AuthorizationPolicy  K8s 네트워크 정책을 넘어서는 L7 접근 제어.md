## AuthorizationPolicy: K8s ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ë„˜ì–´ì„œëŠ” L7 ì ‘ê·¼ ì œì–´

23ì¥ 01ì ˆì—ì„œ `PeerAuthentication`ì„ í†µí•´ ìš°ë¦¬ëŠ” \*\*"ëˆ„ê°€ ëˆ„êµ¬ì™€ í†µì‹ í•  ìˆ˜ ìˆëŠ”ê°€(Authentication)"\*\*ë¥¼ mTLSë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤. ì¦‰, `order-service`ë§Œì´ `product-service`ì„ì„ ì¦ëª…í•œ ìƒëŒ€ì™€ í†µì‹ í•˜ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì•„ì§ í•´ê²°ë˜ì§€ ì•Šì€ ì§ˆë¬¸ì´ ìˆìŠµë‹ˆë‹¤. "ê·¸ë˜ì„œ `order-service`ê°€ `product-service`ì˜ \*\*'ëª¨ë“  API'\*\*ë¥¼ í˜¸ì¶œí•´ë„ ê´œì°®ì€ê°€?" ì´ê²ƒì´ ë°”ë¡œ **ì¸ê°€(Authorization)**, ì¦‰ "ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ê°€"ì˜ ì˜ì—­ì…ë‹ˆë‹¤.

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ë„ `NetworkPolicy`ë¼ëŠ” ê¸°ë³¸ ë°©í™”ë²½ ê¸°ëŠ¥ì´ ìˆì§€ë§Œ, ì´ëŠ” L3/L4(IP, Port) ë ˆë²¨ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤. "A PodëŠ” B Podì™€ í†µì‹ í•  ìˆ˜ ìˆë‹¤"ëŠ” ìˆ˜ì¤€ì˜ ì œì–´ë§Œ ê°€ëŠ¥í•  ë¿, "A Podê°€ B Podì˜ `/admin` ê²½ë¡œëŠ” í˜¸ì¶œí•˜ë©´ ì•ˆ ëœë‹¤"ì™€ ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨(L7)ì˜ ì„¸ë°€í•œ ì œì–´ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

-----

### Istio AuthorizationPolicy: "ìš°ë¦¬ ì§‘ í˜„ê´€ë¬¸ì˜ ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½" ğŸšª

\*\*`AuthorizationPolicy`\*\*ëŠ” Istio ì„œë¹„ìŠ¤ ë©”ì‹œ ë‚´ì—ì„œ ì›Œí¬ë¡œë“œì— ëŒ€í•œ ì ‘ê·¼ ì œì–´ë¥¼ L7 ë ˆë²¨ê¹Œì§€ í™•ì¥í•˜ëŠ” ê°•ë ¥í•œ ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤.

  * **ì¿ ë²„ë„¤í‹°ìŠ¤ `NetworkPolicy`:** ìš°ë¦¬ ì§‘ \*\*'ëŒ€ë¬¸'\*\*ê³¼ ê°™ìŠµë‹ˆë‹¤. "ìš°ë¦¬ ê°€ì¡±(íŠ¹ì • ë ˆì´ë¸”ì„ ê°€ì§„ Pod)ë§Œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆë‹¤"ëŠ” ê·œì¹™ì„ ì„¤ì •í•©ë‹ˆë‹¤.
  * **Istio `AuthorizationPolicy`:** ê° ë°©ë§ˆë‹¤ ì„¤ì¹˜ëœ \*\*'ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½'\*\*ê³¼ ê°™ìŠµë‹ˆë‹¤. "ì•„ë¹ (íŠ¹ì • ì„œë¹„ìŠ¤ ê³„ì •)ë§Œ ì„œì¬(`GET /admin/stats`)ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆê³ , ì•„ì´ë“¤(ë‹¤ë¥¸ ì„œë¹„ìŠ¤)ì€ ê±°ì‹¤(`GET /products`)ì—ë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤"ì™€ ê°™ì´ í›¨ì”¬ ë” ì„¸ë¶„í™”ëœ ê·œì¹™ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`AuthorizationPolicy`ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìš”ì†Œë“¤ì„ ì¡°í•©í•˜ì—¬ ê·œì¹™ì„ ë§Œë“­ë‹ˆë‹¤.

1.  **`selector`:** ì´ ì •ì±…ì´ ì ìš©ë  **'ëŒ€ìƒ'** ì›Œí¬ë¡œë“œ(Pod)ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
2.  **`action`:** ì •ì±…ì— ì¼ì¹˜í•˜ëŠ” ìš”ì²­ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ ê²°ì •í•©ë‹ˆë‹¤. (`ALLOW`: í—ˆìš©, `DENY`: ê±°ë¶€)
3.  **`rules`:** ì–´ë–¤ ìš”ì²­ì„ í—ˆìš©í•˜ê±°ë‚˜ ê±°ë¶€í• ì§€ì— ëŒ€í•œ **'ì¡°ê±´'** ëª©ë¡ì…ë‹ˆë‹¤.
      * **`from`:** ëˆ„ê°€ ìš”ì²­ì„ ë³´ëƒˆëŠ”ê°€? (Source)
          * `principals`: mTLS ì¸ì¦ì„œì˜ ì‹ ì›(Service Account)
      * **`to`:** ì–´ë–¤ ì‘ì—…ì„ ìš”ì²­í–ˆëŠ”ê°€? (Operation)
          * `methods`: HTTP ë©”ì„œë“œ (`GET`, `POST`)
          * `paths`: HTTP ê²½ë¡œ (`/api/v1/products`)
          * `ports`: í¬íŠ¸ ë²ˆí˜¸

-----

### ì‹¤ì „: `product-service`ì˜ ì¤‘ìš” API ë³´í˜¸í•˜ê¸°

**ì‹œë‚˜ë¦¬ì˜¤:** `product-service`ì—ëŠ” ë‘ ê°€ì§€ ì¢…ë¥˜ì˜ APIê°€ ìˆë‹¤ê³  ê°€ì •í•´ ë´…ì‹œë‹¤.

  * \*\*`GET /api/v1/products/**`: ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” API. ëª¨ë“  ì„œë¹„ìŠ¤ê°€ í˜¸ì¶œí•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
  * **`POST /api/v1/products/internal/decrease-stock`**: ì¬ê³ ë¥¼ ì§ì ‘ ì°¨ê°í•˜ëŠ” ë§¤ìš° ë¯¼ê°í•œ ë‚´ë¶€ìš© API. **ì˜¤ì§ `order-service`ë§Œ**ì´ í˜¸ì¶œí•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ì´ ê·œì¹™ì„ `AuthorizationPolicy`ë¡œ êµ¬í˜„í•´ ë´…ì‹œë‹¤.

#### 1ë‹¨ê³„ (ì‚¬ì „ ì‘ì—…): ê¸°ë³¸ Deny All ì •ì±… ì ìš©

ì œë¡œ íŠ¸ëŸ¬ìŠ¤íŠ¸ ì›ì¹™ì— ë”°ë¼, ë¨¼ì € `product-service`ë¡œ ê°€ëŠ” \*\*ëª¨ë“  íŠ¸ë˜í”½ì„ ê¸°ë³¸ì ìœ¼ë¡œ ê±°ë¶€(Deny All)\*\*í•˜ëŠ” ì •ì±…ì„ ì ìš©í•©ë‹ˆë‹¤.

```yaml
# product-service-deny-all.yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: product-service-deny-all
spec:
  # 1. product-serviceì— ì´ ì •ì±…ì„ ì ìš©
  selector:
    matchLabels:
      app: product-service
  # 2. ì•„ë¬´ëŸ° rulesê°€ ì—†ìœ¼ë©´ ëª¨ë“  ìš”ì²­ì— ë§¤ì¹˜ë¨
  #    actionì´ ëª…ì‹œë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ì€ ALLOW.
  #    ë”°ë¼ì„œ ë¹ˆ rulesë¥¼ ê°€ì§„ ALLOW ì •ì±…ì€ "ëª¨ë‘ í—ˆìš©"
  #    ê·œì¹™ì´ ì—†ëŠ” DENY ì •ì±…ì€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ALLOW ì •ì±…ì„ ëª…ì‹œì ìœ¼ë¡œ ë§Œë“¦.
  #    (ì‹¤ì œë¡œëŠ” ê¸°ë³¸ ALLOW í›„ íŠ¹ì • ê²½ë¡œ DENY ë˜ëŠ” ê¸°ë³¸ DENY í›„ íŠ¹ì • ê²½ë¡œ ALLOW)
  #    ì—¬ê¸°ì„œëŠ” ëª…ì‹œì  ALLOW ì •ì±…ì„ ë§Œë“¤ì–´ ì œì–´.
  action: ALLOW
  # rules: [] # ê·œì¹™ì´ ì—†ìœ¼ë©´ ëª¨ë“  ìš”ì²­ í—ˆìš©
```

> **ìˆ˜ì •:** ì œë¡œ íŠ¸ëŸ¬ìŠ¤íŠ¸ë¥¼ ìœ„í•´, ìš°ë¦¬ëŠ” ë¨¼ì € `product-service`ë¡œ í–¥í•˜ëŠ” **ëª¨ë“ ** ìš”ì²­ì„ í—ˆìš©í•˜ë˜, íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” ìš”ì²­ë§Œ **ì„ ë³„ì ìœ¼ë¡œ** í—ˆìš©í•˜ëŠ” `ALLOW` ì •ì±…ì„ ì—¬ëŸ¬ ê°œ ë‘˜ ê²ƒì…ë‹ˆë‹¤. ë§Œì•½ ì•„ë¬´ëŸ° `ALLOW` ì •ì±…ê³¼ë„ ë§¤ì¹˜ë˜ì§€ ì•Šìœ¼ë©´, Istioì˜ ê¸°ë³¸ ë™ì‘ì€ \*\*ì•”ë¬µì  ê±°ë¶€(Implicit Deny)\*\*ì…ë‹ˆë‹¤.

#### 2ë‹¨ê³„: ì„ ë³„ì  `ALLOW` ì •ì±… ì‘ì„±

ì´ì œ í•„ìš”í•œ íŠ¸ë˜í”½ë§Œ ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©í•˜ëŠ” ì •ì±…ë“¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```yaml
# product-service-allow-policy.yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: product-service-allow-policy
spec:
  selector:
    matchLabels:
      app: product-service
  action: ALLOW
  rules:
    # --- ê·œì¹™ 1: ìƒí’ˆ ì¡°íšŒ APIëŠ” ëª¨ë‘ì—ê²Œ í—ˆìš© ---
    - to:
        - operation:
            methods: ["GET"]
            paths: ["/api/v1/products*", "/actuator/health*"] # í—¬ìŠ¤ ì²´í¬ ê²½ë¡œë„ í•„ìˆ˜
    
    # --- ê·œì¹™ 2: ì¬ê³  ì°¨ê° APIëŠ” ì˜¤ì§ order-serviceì—ê²Œë§Œ í—ˆìš© ---
    - from:
        - source:
            # 1. ìš”ì²­ì„ ë³´ë‚¸ ì£¼ì²´ì˜ Service Accountê°€ 'order-service-sa'ì¼ ë•Œ
            principals: ["cluster.local/ns/default/sa/order-service-sa"]
      to:
        - operation:
            methods: ["POST"]
            paths: ["/api/v1/products/internal/decrease-stock"]
```

  * **`principals`**: mTLS í•¸ë“œì…°ì´í¬ë¥¼ í†µí•´ í™•ì¸ëœ í´ë¼ì´ì–¸íŠ¸ì˜ ì‹ ì›ì…ë‹ˆë‹¤. `order-service`ì˜ `Deployment`ì— `serviceAccountName: order-service-sa`ë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

#### 3ë‹¨ê³„: ì •ì±… ì ìš© ë° í…ŒìŠ¤íŠ¸

```bash
kubectl apply -f product-service-allow-policy.yaml
```

ì´ì œ ì •ì±…ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.

  * `member-service` Podì—ì„œ `product-service`ë¡œ `GET /api/v1/products/1`ì„ í˜¸ì¶œí•˜ë©´? **ì„±ê³µ (200 OK)**
  * `member-service` Podì—ì„œ `product-service`ë¡œ `POST /api/v1/products/internal/decrease-stock`ë¥¼ í˜¸ì¶œí•˜ë©´? **ì‹¤íŒ¨ (403 Forbidden)**
  * `order-service` Podì—ì„œ `product-service`ë¡œ `POST /api/v1/products/internal/decrease-stock`ë¥¼ í˜¸ì¶œí•˜ë©´? **ì„±ê³µ (200 OK)**

-----

**ê²°ë¡ ì ìœ¼ë¡œ,** Istio `AuthorizationPolicy`ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ L3/L4 `NetworkPolicy`ë¥¼ í›¨ì”¬ ë›°ì–´ë„˜ëŠ”, **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨(L7)ì˜ ì„¸ë¶„í™”ëœ ì ‘ê·¼ ì œì–´**ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. mTLSë¡œ \*\*"ëˆ„êµ¬ì¸ì§€(Authentication)"\*\*ë¥¼ ì¦ëª…í•˜ê³ , `AuthorizationPolicy`ë¡œ \*\*"ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ì§€(Authorization)"\*\*ë¥¼ ì œì–´í•¨ìœ¼ë¡œì¨, ìš°ë¦¬ëŠ” ì½”ë“œ ë³€ê²½ ì—†ì´ë„ ë§¤ìš° ê°•ë ¥í•˜ê³  ìœ ì—°í•œ ì œë¡œ íŠ¸ëŸ¬ìŠ¤íŠ¸ ë³´ì•ˆ ëª¨ë¸ì„ ì„œë¹„ìŠ¤ ë©”ì‹œì— êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.