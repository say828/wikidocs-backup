## CD(Continuous Delivery): 배포 전략 (롤링 업데이트, 카나리, 블루/그린)

CI 파이프라인이 성공적으로 완료되면, 우리는 '품질이 검증된' 컨테이너 이미지를 갖게 됩니다. 이제 **CD(Continuous Delivery, 지속적인 전달)**는 이 이미지를 실제 서버(쿠버네티스 클러스터)에 **어떻게 안전하고 효율적으로 배포할 것인가**에 대한 전략을 다룹니다.

과거에는 서버 전체를 중단시키고(Downtime) 새로운 버전의 애플리케이션을 배포하는 것이 일반적이었습니다. 하지만 24시간 365일 운영되어야 하는 현대적인 MSA 환경에서 서비스 중단은 곧 비즈니스의 손실을 의미합니다. 따라서 우리는 **무중단 배포(Zero-Downtime Deployment)**를 목표로 해야 합니다.

쿠버네티스는 다양한 무중단 배포 전략을 기본적으로 지원합니다. 각 전략은 '안정성'과 '배포 속도' 사이에서 다른 트레이드오프를 가집니다.

---

### 1. 롤링 업데이트 (Rolling Update): 점진적인 세대교체 🌊

* **개념:** 쿠버네티스 `Deployment`의 **기본 배포 전략**입니다. 새로운 버전의 Pod를 하나씩 점진적으로 생성하면서, 구버전의 Pod를 하나씩 점진적으로 제거하는 방식입니다.
* **비유:** **"운행 중인 차선 하나씩 교체하기"**. 전체 고속도로를 막지 않고, 1차선부터 공사를 시작하고, 끝나면 2차선 공사를 시작하는 방식입니다.
* **동작 방식 (K8s):**
    1.  `Deployment`의 컨테이너 이미지를 `v1`에서 `v2`로 업데이트합니다.
    2.  쿠버네티스는 먼저 `v2` Pod를 하나 생성하고 'Ready' 상태가 될 때까지 기다립니다.
    3.  `v2` Pod가 정상적으로 트래픽을 받을 준비가 되면, `v1` Pod 중 하나를 종료시킵니다.
    4.  이 과정을 `replicas` 수만큼 반복하여 모든 Pod가 `v2`로 교체될 때까지 점진적으로 진행합니다.
* **장점:**
    * **단순함:** 추가적인 설정 없이 쿠버네티스가 기본으로 제공하는 가장 간단한 무중단 배포 방식입니다.
    * **자원 효율성:** 배포 중 필요한 추가 자원이 최대 Pod 1개 분량으로 매우 적습니다.
* **단점:**
    * **느린 롤백:** 배포 중간에 심각한 버그가 발견되어도, 롤백 과정 역시 롤링 방식으로 점진적으로 진행되어 시간이 걸립니다.
    * **버전 혼재:** 배포가 진행되는 동안에는 `v1` Pod와 `v2` Pod가 동시에 트래픽을 처리하는 기간이 존재합니다.

---

### 2. 블루/그린 배포 (Blue/Green Deployment): 예비군과의 완벽한 교대 🔵🟢

* **개념:** 현재 운영 중인 버전(**블루**)과 완전히 동일한 환경에 새로운 버전(**그린**)을 미리 배포해 둔 뒤, 모든 테스트가 완료되면 라우터(쿠버네티스 `Service`)의 트래픽 방향을 **한 번에** 블루에서 그린으로 전환하는 방식입니다.
* **비유:** **"공연의 주연 배우와 대역 배우"**. 주연 배우(블루)가 공연하는 동안, 대역 배우(그린)는 무대 뒤에서 완벽하게 분장을 마치고 모든 준비를 끝냅니다. 교체 시간이 되면, 조명이 꺼졌다 켜지는 순간 두 배우가 자리를 바꿉니다. 관객은 배우가 바뀐 사실조차 모를 수 있습니다.
* **동작 방식 (K8s):**
    1.  현재 `product-service-v1` (블루)이 `Service`에 연결되어 트래픽을 받고 있습니다.
    2.  CI/CD 파이프라인은 `product-service-v2` (그린) Deployment를 클러스터에 배포합니다. 이 시점에는 그린 버전으로 가는 트래픽이 전혀 없습니다.
    3.  그린 버전을 대상으로 스모크 테스트 등 모든 검증을 수행합니다.
    4.  배포를 결정하면, `Service`의 `selector`가 가리키는 대상을 `app: product-service-v1`에서 `app: product-service-v2`로 **단 한 번의 `kubectl apply`**로 변경합니다.
    5.  모든 사용자 트래픽이 즉시 그린 버전으로 전환됩니다.
* **장점:**
    * **즉각적인 롤백:** 그린 버전에 문제가 발견되면, `Service`의 `selector`를 다시 `v1`으로 되돌리는 것만으로 **거의 즉시** 롤백이 가능합니다. 매우 안전합니다.
    * **버전 혼재 없음:** 사용자는 항상 100% 블루 또는 100% 그린 버전의 서비스만 경험합니다.
* **단점:**
    * **비용:** 운영 환경과 동일한 규모의 인프라(그린 환경)가 배포 시간 동안 **두 배**로 필요하므로 비용이 많이 듭니다.

---

### 3. 카나리 배포 (Canary Release): 위험을 감지하는 카나리아 🐦

* **개념:** 과거 광부들이 유독가스를 감지하기 위해 카나리아 새를 먼저 탄광에 들여보냈던 것에서 유래했습니다. 새로운 버전을 **아주 소수의 사용자(예: 1%)에게만 먼저 공개**하여, 실제 운영 환경에서 문제가 없는지 확인한 후 점진적으로 전체 사용자에게 확대하는 가장 정교하고 진보된 배포 전략입니다.
* **비유:** **"신제품의 시식 코너"**. 새로운 맛의 음료수를 출시하기 전에, 마트의 작은 시식 코너에서 소수의 고객에게 먼저 맛을 보여주고 반응을 살핍니다. 반응이 좋으면 전국 매장으로 확대하고, 나쁘면 즉시 철수합니다.
* **동작 방식 (K8s):**
    1.  `product-service-v1` Deployment (`replicas: 9`)와 `product-service-v2` Deployment (`replicas: 1`)를 동시에 운영합니다.
    2.  쿠버네티스 `Service`는 두 버전의 Pod를 모두 바라보게 하여, 전체 트래픽의 90%는 `v1`으로, **10%는 `v2`로 분산**시킵니다.
    3.  모니터링 시스템(프로메테우스, 그라파나)을 통해 `v2` 버전의 에러율, 응답 시간 등 핵심 지표를 면밀히 관찰합니다.
    4.  `v2`가 안정적이라고 판단되면, `v2`의 `replicas` 수를 점진적으로 늘리고 `v1`을 줄여나가 최종적으로 100% 전환합니다.
* **장점:**
    * **가장 안전함:** 실제 운영 트래픽을 대상으로 새로운 버전의 위험성을 **최소화된 반경** 내에서 검증할 수 있습니다.
    * **A/B 테스팅:** 배포 전략을 넘어, 특정 사용자 그룹에게만 새로운 기능을 노출하는 A/B 테스팅 플랫폼으로도 활용할 수 있습니다.
* **단점:**
    * **가장 복잡함:** 정교한 트래픽 분배와 자동화된 결과 분석을 위해 **Istio**나 **Linkerd**와 같은 **서비스 메시(Service Mesh)**나 **프로그레시브 딜리버리(Progressive Delivery)** 도구가 거의 필수적으로 요구됩니다. (22장에서 자세히 다룹니다.)

각 배포 전략은 장단점이 명확하므로, 서비스의 중요도와 팀의 성숙도에 따라 적절한 전략을 선택해야 합니다. 일반적으로는 **롤링 업데이트**로 시작하여, 안정성이 매우 중요한 핵심 서비스에는 **블루/그린**을, 데이터 기반의 점진적인 검증이 필요할 때는 **카나리**를 도입하는 방식으로 발전해 나갑니다.