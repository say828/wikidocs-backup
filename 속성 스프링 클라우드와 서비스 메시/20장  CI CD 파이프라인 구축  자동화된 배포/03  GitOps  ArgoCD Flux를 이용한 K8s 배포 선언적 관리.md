## GitOps: ArgoCD/Flux를 이용한 K8s 배포 선언적 관리

20장 01절에서 우리는 CI/CD 파이프라인이 컨테이너 이미지를 빌드하고 `kubectl`이나 `Helm` 명령어를 실행하여 쿠버네티스에 배포하는 **'푸시(Push)' 기반**의 모델을 설계했습니다. 이 방식은 매우 효과적이지만, 최고의 실무 환경에서는 다음과 같은 근본적인 문제점을 가집니다.

* **보안 문제:** CI 서버(GitHub Actions)가 프로덕션 클러스터에 직접 접근할 수 있는 강력한 '관리자급' 권한을 가져야 합니다. 만약 CI 서버가 해킹당하면, 전체 프로덕션 클러스터가 위험에 노출됩니다.
* **상태 불일치 (Drift):** 운영자가 급한 장애 대응을 위해 `kubectl edit deployment` 명령어로 프로덕션의 Pod 개수를 수동으로 `3`에서 `5`로 늘렸다고 가정해 봅시다. 이제 클러스터의 **'실제 상태'**는 배포 코드가 저장된 Git 저장소의 **'원하는 상태'**(`replicas: 3`)와 달라졌습니다. 이 '상태 불일치(Configuration Drift)'는 향후 배포 시 예기치 않은 문제를 일으키는 원인이 됩니다.

이 문제들을 해결하는 가장 현대적이고 안전한 배포 패러다임이 바로 **GitOps**입니다.

---

### GitOps: "Git이 곧 운영 환경이다"

GitOps의 핵심 철학은 단순하고 강력합니다.

> **"애플리케이션 소스 코드의 '진실의 원천(Single Source of Truth)'이 Git이듯이, 인프라와 애플리케이션 배포의 '진실의 원천' 또한 Git이어야 한다."**

GitOps는 CI 서버가 클러스터에 변경 사항을 밀어 넣는(Push) 대신, 클러스터 내부에서 동작하는 **'GitOps 에이전트'가 Git 저장소를 감시**하다가 변경 사항을 스스로 **가져와서(Pull)** 클러스터의 상태를 동기화하는 **'풀(Pull)' 기반**의 모델입니다.

**스마트 온도 조절기 비유 🌡️:**
* **Manifest Git 저장소:** 당신이 스마트폰 앱에서 설정한 **'희망 온도 (22℃)'**. (원하는 상태)
* **GitOps 에이전트 (ArgoCD/Flux):** 벽에 붙어있는 **'스마트 온도 조절기'**.
* **쿠버네티스 클러스터:** 실제 **'방'**.

온도 조절기(에이전트)는 '희망 온도'와 '실제 방 온도'를 끊임없이 비교합니다.
* 만약 방이 너무 추우면(`상태 불일치`), 온도 조절기는 스스로 보일러를 켭니다(`kubectl apply`).
* 누군가 창문을 열어 방이 다시 추워지면(`Drift 발생`), 온도 조절기는 이를 감지하고 다시 보일러를 켜서 '희망 온도'를 맞춥니다.
당신은 온도 조절기에게 '보일러를 켜라'고 명령하지 않습니다. 오직 '원하는 상태(22℃)'만 선언할 뿐입니다.

---

### GitOps 워크플로우 (ArgoCD 기준)

이 역할을 수행하는 대표적인 CNCF 프로젝트가 `ArgoCD`와 `Flux`입니다. 우리는 뛰어난 시각적 UI를 제공하여 GitOps의 개념을 이해하기 쉬운 **ArgoCD**를 기준으로 설명하겠습니다.



1.  **[CI 파이프라인의 역할 변경]**
    `member-service`의 CI 파이프라인(GitHub Actions)은 더 이상 `kubectl` 명령어를 실행하지 않습니다. 대신, CI의 마지막 단계는 **'Manifest Git 저장소'** (애플리케이션 코드 저장소와는 별개)에 있는 `member-service`의 Helm 차트 `values.yaml` 파일의 **이미지 태그를 `v1.0.1`에서 `v1.0.2`로 업데이트하고 커밋(Commit)**하는 것입니다.

2.  **[ArgoCD의 감지]**
    쿠버네티스 클러스터 안에서 실행 중인 ArgoCD 에이전트는 'Manifest Git 저장소'의 변경 사항을 감지합니다.

3.  **[상태 비교 및 동기화 (Sync)]**
    ArgoCD는 Git의 새로운 상태('v1.0.2' 이미지를 사용해야 함)와 클러스터의 현재 상태('v1.0.1' 이미지를 사용 중)가 다름을 인지하고 **'Out of Sync'** 상태로 표시합니다.

4.  **[자동 배포]**
    (설정에 따라 자동 또는 수동으로) 'Sync' 버튼을 누르면, ArgoCD가 클러스터에 직접 `helm upgrade` 또는 `kubectl apply`를 실행하여, `member-service`의 롤링 업데이트를 트리거하고 클러스터의 상태를 Git과 동일하게 맞춥니다.

---

### GitOps의 장점

* **향상된 보안:** CI 서버는 더 이상 프로덕션 클러스터의 비밀키를 가질 필요가 없습니다. 공격 표면이 크게 줄어듭니다.
* **일관성 및 신뢰성:** Git 저장소가 유일한 진실의 원천이므로, '상태 불일치'가 발생하지 않습니다. ArgoCD UI를 통해 현재 배포 상태와 Git 상태를 명확하게 시각적으로 확인할 수 있습니다.
* **손쉬운 롤백:** 배포에 문제가 생겼나요? 프로덕션 클러스터에 직접 명령을 내릴 필요 없이, **Manifest 저장소의 문제 커밋을 `git revert`** 하기만 하면 됩니다. ArgoCD가 이 변경을 감지하고 이전 상태로 클러스터를 자동으로 되돌려줍니다.
* **명확한 감사 추적:** 누가, 언제, 왜 프로덕션 환경을 변경했는지에 대한 모든 기록이 Git 커밋 로그에 남습니다.

GitOps는 쿠버네티스 환경의 CD를 위한 차세대 패러다임입니다. Git을 시스템 전체의 '제어 평면(Control Plane)'으로 사용함으로써, 개발팀에게는 더 빠른 배포 속도를, 운영팀에게는 더 높은 안정성과 보안을 제공하는 강력한 개발 워크플로우입니다.