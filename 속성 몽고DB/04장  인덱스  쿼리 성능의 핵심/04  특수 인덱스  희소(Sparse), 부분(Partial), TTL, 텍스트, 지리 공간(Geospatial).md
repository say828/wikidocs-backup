## 04\. 특수 인덱스: 희소(Sparse), 부분(Partial), TTL, 텍스트, 지리 공간(Geospatial)

기본적인 B-Tree 인덱스 외에도, MongoDB는 특정 데이터 유형이나 쿼리 패턴을 매우 효율적으로 처리하기 위해 설계된 다양한 특수 인덱스를 제공합니다. 이 도구들을 적재적소에 활용하면 일반 인덱스로는 해결하기 어려운 문제들을 우아하게 풀어낼 수 있습니다.

-----

### 희소 인덱스 (Sparse Index)

**희소 인덱스**는 인덱싱 대상 필드가 **존재하는 도큐먼트에 대해서만** 인덱스 항목을 생성합니다. 만약 도큐먼트에 해당 필드가 아예 없다면, 그 도큐먼트는 인덱스에 포함되지 않습니다.

  * **용도:** 컬렉션의 일부 도큐먼트에만 선택적으로 존재하는 필드를 쿼리할 때 유용합니다. 예를 들어, 프리미엄 사용자에게만 `premium_features` 필드가 있는 경우, 이 필드에 희소 인덱스를 생성하면 일반 사용자 도큐먼트들은 인덱스에서 제외되어 인덱스의 크기가 작고 효율적으로 유지됩니다.

  * **구문:**

    ```javascript
    // premium_features 필드가 있는 문서만 인덱싱
    db.users.createIndex({ premium_features: 1 }, { sparse: true })
    ```

-----

### 부분 인덱스 (Partial Index)

**부분 인덱스**는 희소 인덱스보다 한 단계 더 나아가, 지정된 **필터 조건(`partialFilterExpression`)을 만족하는 도큐먼트들만** 인덱싱합니다.

  * **용도:** 컬렉션 내에서 자주 쿼리되는 특정 상태의 '핫(hot)' 데이터셋에 대해서만 작고 빠른 인덱스를 만들고 싶을 때 매우 강력합니다.

  * **이커머스 예시:** 전체 주문(`orders`) 중에서 아직 배송되지 않은(`status: "PENDING"`) 소수의 주문들만 빠르게 조회하고 싶을 때, 이 주문들만을 대상으로 하는 부분 인덱스를 생성할 수 있습니다.

  * **구문:**

    ```javascript
    // 'PENDING' 상태의 주문들만 'orderDate' 필드로 인덱싱
    db.orders.createIndex(
      { orderDate: 1 },
      { partialFilterExpression: { status: "PENDING" } }
    )
    ```

    이 인덱스는 전체 주문이 수억 건이라도, 'PENDING' 상태의 주문이 수천 건에 불과하다면 매우 작고 빠르게 동작합니다.

-----

### TTL 인덱스 (Time-To-Live Index)

TTL 인덱스는 쿼리 성능 향상이 아닌 **데이터 수명 주기 관리**를 위한 특수 인덱스입니다. 이 인덱스는 특정 시간이 지나면 도큐먼트를 컬렉션에서 **자동으로 삭제**하는 기능을 제공합니다. (02장에서 다룬 내용의 요약입니다.)

  * **용도:** 웹사이트 세션, 로그 데이터, 캐시 데이터 등 일정 시간이 지나면 무의미해지는 데이터를 별도의 로직 없이 자동으로 정리할 때 사용합니다.

  * **구문:**

    ```javascript
    // createdAt 필드의 시간으로부터 3600초(1시간)가 지나면 자동 삭제
    db.sessions.createIndex({ createdAt: 1 }, { expireAfterSeconds: 3600 })
    ```

-----

### 텍스트 인덱스 (Text Index)

**텍스트 인덱스**는 문자열 내용에 대한 **텍스트 검색(Full-text Search)** 기능을 지원합니다. 단순 문자열 매칭이 아니라, 언어별로 단어를 분석(어간 추출, 불용어 처리 등)하여 검색어와 관련된 도큐먼트를 효율적으로 찾아줍니다.

  * **용도:** 상품 설명, 게시글 본문, 리뷰 내용 등 장문의 텍스트 내에서 키워드 검색 기능을 구현할 때 사용합니다.

  * **구문:** 컬렉션당 최대 하나의 텍스트 인덱스만 생성할 수 있습니다.

    ```javascript
    // 상품명(name)과 설명(description) 필드를 텍스트 검색 대상으로 지정
    db.products.createIndex({ name: "text", description: "text" })
    ```

  * **쿼리:** `$text` 연산자를 사용하여 검색합니다.

    ```javascript
    // '신상' 또는 '노트북' 이라는 단어가 포함된 상품 검색
    db.products.find({ $text: { $search: "신상 노트북" } })
    ```

-----

### 지리 공간 인덱스 (Geospatial Index)

**지리 공간 인덱스**는 위도, 경도와 같은 좌표 데이터를 효율적으로 쿼리할 수 있도록 지원합니다.

  * **용도:** "내 위치에서 가장 가까운 매장 5곳 찾기", "특정 반경 내에 있는 배달 기사 검색" 등 위치 기반 서비스(LBS)의 핵심 기능 구현에 사용됩니다.

  * **인덱스 타입:** `2dsphere` 인덱스는 구(sphere) 형태의 지구 표면 위에서의 거리 계산을 정확하게 지원하므로 표준으로 사용됩니다. 데이터는 **GeoJSON** 형식(예: `Point`)으로 저장해야 합니다.

  * **이커머스 예시:** 사용자 위치를 기준으로 가장 가까운 오프라인 매장 찾기

      * **인덱스 생성:**

        ```javascript
        // 매장 위치 정보가 저장된 location 필드에 2dsphere 인덱스 생성
        db.stores.createIndex({ location: "2dsphere" })
        ```

      * **쿼리:** `$near` 연산자를 사용하여 특정 지점 근방을 검색합니다.

        ```javascript
        // 경기도 성남시 부근(경도, 위도) 5km 반경 내 매장 검색
        db.stores.find({
          location: {
            $near: {
              $geometry: { type: "Point", coordinates: [ 127.1053, 37.3596 ] },
              $maxDistance: 5000 // 최대 검색 반경(미터 단위)
            }
          }
        })
        ```

이러한 특수 인덱스들은 MongoDB가 단순한 문서 저장소를 넘어, 검색 엔진, 캐시 서버, 위치 기반 서비스 플랫폼 등 다용도로 활용될 수 있게 만드는 강력한 무기입니다.