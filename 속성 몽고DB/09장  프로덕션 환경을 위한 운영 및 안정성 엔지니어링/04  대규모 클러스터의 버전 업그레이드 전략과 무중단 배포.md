## 04\. 대규모 클러스터의 버전 업그레이드 전략과 무중단 배포

소프트웨어는 끊임없이 발전하며, MongoDB 역시 새로운 기능, 성능 향상, 보안 패치를 담아 정기적으로 새로운 버전을 출시합니다. 하지만 24시간 운영되는 대규모 프로덕션 데이터베이스를 다운타임 없이 새로운 버전으로 업그레이드하는 것은, 마치 고속으로 달리는 자동차의 엔진을 교체하는 것과 같은 고도의 정밀함과 계획이 요구되는 작업입니다.

이번 절에서는 서비스 중단 없이 안전하게 MongoDB 클러스터를 업그레이드하기 위한 **롤링 업그레이드(Rolling Upgrade)** 방법론과 그 핵심 전략을 알아봅니다.

-----

### 업그레이드 전 필수 확인 사항 (Pre-Upgrade Checklist)

업그레이드 버튼을 누르기 전에, 성공적인 결과를 위해 반드시 다음 사항들을 점검해야 합니다.

1.  **릴리스 노트 정독:** 업그레이드하려는 목표 버전의 릴리스 노트를 반드시 읽어야 합니다. 여기에는 다음과 같은 핵심 정보가 포함되어 있습니다.

      * **호환성 문제 (Backward-Incompatible Changes):** 기존 애플리케이션의 동작을 중단시킬 수 있는 변경 사항.
      * **업그레이드 경로:** 특정 버전은 바로 점프할 수 없고, 중간 버전을 거쳐야 할 수 있습니다. (예: 4.4 → 5.0 → 6.0 순서)
      * **드라이버 호환성:** 현재 사용 중인 애플리케이션의 MongoDB 드라이버가 목표 버전과 호환되는지 확인해야 합니다.

2.  **FCV(Feature Compatibility Version) 확인:** FCV는 클러스터가 어떤 버전의 기능을 활성화할지를 결정하는 내부 설정입니다. 예를 들어 5.0에서 6.0으로 업그레이드하려면, FCV가 `5.0`으로 설정되어 있어야 합니다. 업그레이드 시작 전에 이 값을 반드시 확인해야 합니다.

3.  **백업:** 모든 주요 변경 작업 전에는 반드시 검증된 전체 백업을 수행해야 합니다. 이것이 우리의 유일한 안전망입니다.

4.  **스테이징 환경 테스트:** 절대로 프로덕션 환경에서 처음으로 업그레이드를 시도해서는 안 됩니다. 프로덕션과 거의 동일한 구성의 스테이징 환경에서 전체 업그레이드 절차를 완벽하게 예행연습해야 합니다.

-----

### 무중단 롤링 업그레이드 절차

핵심 원리는 **한 번에 하나씩, 세컨더리부터** 업그레이드하여, 항상 과반수의 멤버와 프라이머리가 온라인 상태를 유지하도록 하는 것입니다.

#### A. 레플리카 셋 업그레이드

1.  **세컨더리 업그레이드:** 세컨더리 노드 중 하나를 선택하여 `mongod` 프로세스를 중지합니다. MongoDB 바이너리를 새 버전으로 교체한 후, `mongod`를 다시 시작합니다. 노드는 잠시 후 레플리카 셋에 세컨더리로 다시 합류하여 데이터를 동기화합니다.
2.  **모든 세컨더리에 대해 반복:** 남은 모든 세컨더리 노드에 대해 1번 과정을 순서대로 반복합니다. 이제 모든 세컨더리는 새 버전이지만, 프라이머리는 아직 구 버전인 '혼합 버전' 상태가 됩니다.
3.  **프라이머리 스텝다운 및 업그레이드:** 프라이머리에 접속하여 `rs.stepDown()` 명령을 실행합니다. 이는 강제로 선거를 유발하여, 이미 새 버전으로 업그레이드된 세컨더리 중 하나가 새로운 프라이머리로 선출되게 합니다. 기존 프라이머리는 이제 세컨더리가 됩니다.
4.  구 프라이머리(이제 세컨더리)를 중지하고, 바이너리를 업그레이드한 후 재시작합니다. 이제 레플리카 셋의 모든 멤버가 성공적으로 새 버전으로 업그레이드되었습니다.

#### B. 샤드 클러스터 업그레이드

샤드 클러스터는 구성 요소 간의 호환성을 위해 **반드시 정해진 순서**대로 업그레이드를 진행해야 합니다.

**순서: 설정 서버 → 샤드 → `mongos` 라우터**

1.  **밸런서 중지:** 업그레이드 중 청크 이동이 발생하지 않도록 먼저 밸런서를 중지시킵니다.
2.  **설정 서버(Config Servers) 업그레이드:** 설정 서버 레플리카 셋에 대해 위에서 설명한 **레플리카 셋 롤링 업그레이드** 절차를 수행합니다.
3.  **각 샤드(Shards) 업그레이드:** 클러스터 내의 **각 샤드에 대해** 순서대로 **레플리카 셋 롤링 업그레이드** 절차를 수행합니다. (샤드 A 업그레이드 완료 → 샤드 B 업그레이드 완료 → ...)
4.  **`mongos` 라우터 업그레이드:** `mongos` 인스턴스들을 하나씩 중지하고, 바이너리를 업그레이드한 후 재시작합니다. `mongos`는 상태를 저장하지 않으므로, 여러 대가 로드밸런서 뒤에 있다면 순차적으로 재시작해도 서비스에 영향이 없습니다.
5.  **밸런서 재시작:** 모든 구성 요소의 업그레이드가 완료되면, 중지했던 밸런서를 다시 시작합니다.

-----

### 업그레이드 후 작업

모든 노드의 바이너리 업그레이드가 완료된 후, 마지막으로 FCV 값을 새로운 버전으로 변경하여 해당 버전의 모든 기능을 활성화해야 합니다. 이 작업은 되돌릴 수 없으므로 신중해야 합니다.

```kotlin
// Kotlin 코드로 FCV를 6.0으로 설정하는 예시
// admin 데이터베이스에 대해 실행해야 합니다.
val adminDb = client.getDatabase("admin")
try {
    adminDb.runCommand(Document("setFeatureCompatibilityVersion", "6.0"))
    println("Feature Compatibility Version updated to 6.0")
} catch (e: Exception) {
    println("Failed to update FCV: ${e.message}")
}
```

FCV 변경 후에는 시스템의 핵심 지표들을 면밀히 모니터링하여, 업그레이드로 인한 성능 변화나 예기치 않은 문제가 없는지 확인해야 합니다.

### MongoDB Atlas의 자동화된 업그레이드

이처럼 복잡하고 위험 부담이 큰 업그레이드 과정을 **MongoDB Atlas**는 버튼 클릭 몇 번으로 자동화합니다. 사용자가 원하는 버전과 유지보수 시간대를 선택하면, Atlas가 위에서 설명한 모든 모범 사례를 준수하며 백그라운드에서 안전한 롤링 업그레이드를 자동으로 수행해 줍니다. 이는 운영 부담과 리스크를 획기적으로 줄여주는 관리형 서비스의 큰 장점 중 하나입니다.