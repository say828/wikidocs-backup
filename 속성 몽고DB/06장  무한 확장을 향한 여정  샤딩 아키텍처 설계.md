# 06장: 무한 확장을 향한 여정: 샤딩 아키텍처 설계

지금까지 우리는 단일 서버, 혹은 고가용성을 위한 레플리카 셋 환경을 기준으로 MongoDB의 강력한 기능들을 탐구했습니다. 하지만 애플리케이션이 폭발적으로 성장하여 데이터의 양과 트래픽이 단일 레플리카 셋의 한계를 넘어서기 시작하면 어떻게 해야 할까요? 하나의 프라이머리 노드가 감당할 수 있는 쓰기 용량의 한계에 부딪혔을 때, 진정한 의미의 '무한한 확장성'을 확보하기 위한 MongoDB의 해답이 바로 **샤딩(Sharding)**입니다.

이번 장에서는 MongoDB의 수평적 확장 아키텍처인 샤딩의 개념과 내부 동작 원리를 이해하고, 클러스터의 운명을 좌우하는 샤드 키 선정 전략부터 실제 빅테크 기업들이 사용하는 고급 샤딩 기법까지, 대규모 데이터베이스 아키텍처를 설계하는 기술을 마스터하게 될 것입니다.

---

## 00. 수직적 확장과 수평적 확장의 근본적 차이

애플리케이션의 증가하는 부하를 감당하기 위해 데이터베이스의 용량을 늘리는 방법은 근본적으로 두 가지 접근법으로 나뉩니다.

### 수직적 확장 (Vertical Scaling / Scale-Up) ⬆️

**수직적 확장**은 현재 사용 중인 **단일 서버의 성능을 높이는** 방식입니다. 마치 짐이 너무 많아져서 작은 트럭을 더 크고 강력한 대형 트럭으로 바꾸는 것과 같습니다.

* **방법:** 더 많은 CPU 코어, 더 큰 용량의 RAM, 더 빠른 SSD 등 고사양의 부품으로 교체하거나, 클라우드 환경에서 더 높은 등급의 인스턴스로 마이그레이션하는 것입니다.
* **장점:**
    * **단순함:** 데이터베이스 아키텍처나 애플리케이션의 연결 로직을 전혀 변경할 필요가 없습니다. 그냥 더 좋은 컴퓨터에서 같은 소프트웨어를 실행하는 것과 같습니다.
* **단점:**
    * **비용과 한계:** 서버의 성능은 가격과 정비례하지 않고 기하급수적으로 비싸집니다. 또한, 지구상의 어떤 서버도 무한한 CPU와 RAM을 가질 수는 없으므로 명확한 **물리적 한계**에 부딪히게 됩니다.
    * **쓰기 병목:** MongoDB 레플리카 셋은 고가용성을 제공하지만, 모든 쓰기 작업은 여전히 **단 하나의 프라이머리 노드**에서 처리됩니다. 이 프라이머리 서버의 성능이 한계에 도달하면, 시스템 전체의 쓰기 처리량이 정체됩니다.

---

### 수평적 확장 (Horizontal Scaling / Scale-Out) ➡️

**수평적 확장**은 하나의 거대한 서버에 의존하는 대신, **여러 대의 서버에 데이터를 분산하여** 전체 시스템의 용량을 늘리는 방식입니다. 대형 트럭 한 대를 사는 대신, 여러 대의 작은 밴을 사서 배송 구역을 나누어 담당하게 하는 것과 같습니다. 짐이 더 많아지면, 새로운 밴을 한 대 더 추가하기만 하면 됩니다. MongoDB에서는 이 방식을 **샤딩(Sharding)** 이라고 부릅니다.

* **방법:** 전체 데이터를 여러 조각(Chunk)으로 나누어, 각각의 조각을 서로 다른 서버 그룹(샤드, Shard)에 저장합니다. 애플리케이션의 요청은 라우터(`mongos`)를 통해 데이터가 실제 저장된 샤드로 전달됩니다.
* **장점:**
    * **선형적인 확장성:** 시스템 용량이 부족해지면 새로운 샤드를 추가하는 것만으로 거의 선형적으로 전체 용량을 늘릴 수 있습니다. 이론상 **무한한 확장이 가능**합니다.
    * **비용 효율:** 고가의 하이엔드 서버 한 대보다 상대적으로 저렴한 범용(commodity) 서버 여러 대를 사용하는 것이 훨씬 경제적입니다.
    * **높은 처리량:** 읽기와 쓰기 부하가 여러 샤드로 분산되므로, 단일 프라이머리의 쓰기 병목 문제를 근본적으로 해결하고 막대한 양의 동시 트래픽을 처리할 수 있습니다.
* **단점:**
    * **관리 복잡성:** 여러 컴포넌트(샤드, 설정 서버, 라우터)로 구성되므로 아키텍처가 복잡해지고 관리 포인트가 늘어납니다.
    * **설계 의존성:** 데이터를 어떻게 분산시킬지를 결정하는 '샤드 키(Shard Key)'의 설계가 전체 클러스터의 성능을 좌우하며, 한 번 결정하면 변경하기가 매우 어렵습니다.

| 구분 | 수직적 확장 (Scale-Up) | 수평적 확장 (Scale-Out) |
| :--- | :--- | :--- |
| **개념** | 단일 서버의 성능 강화 | 다수의 서버로 부하 분산 |
| **방법** | CPU, RAM, Disk 업그레이드 | 서버(샤드) 추가 |
| **비유** | 트럭을 더 큰 트럭으로 교체 | 트럭(밴)의 대수 늘리기 |
| **장점** | 구조가 단순하고 관리가 용이 | 거의 무한한 확장성, 비용 효율적 |
| **단점** | 비용이 비싸고 물리적 한계 명확 | 아키텍처가 복잡하고 관리 포인트 증가 |
| **MongoDB** | Replica Set의 Primary 서버 사양 올리기 | **Sharded Cluster (샤딩)** |

초기에는 수직적 확장이 간단하고 효과적인 해결책일 수 있지만, 진정으로 대규모 데이터를 다루는 시스템을 지향한다면 결국에는 수평적 확장, 즉 샤딩 아키텍처를 도입해야만 합니다. 다음 절부터는 MongoDB 샤딩을 구성하는 세 가지 핵심 요소에 대해 자세히 알아보겠습니다.