## 04. 청크(Chunk) 분할과 밸런서의 내부 동작 원리

샤드 클러스터에 데이터가 계속해서 추가되다 보면, 특정 샤드에 데이터가 몰리거나 데이터 조각이 너무 커지는 상황이 발생합니다. MongoDB는 이러한 불균형을 자동으로 감지하고 해결하여 클러스터가 항상 최적의 상태를 유지하도록 하는 두 가지 핵심 백그라운드 메커니즘을 가지고 있습니다: 바로 **청크 분할(Chunk Splitting)**과 **밸런서(Balancer)**입니다.

---

### 청크(Chunk): 데이터 분산의 기본 단위

먼저 **청크**의 개념을 명확히 해야 합니다. 청크는 샤딩된 컬렉션에서 **샤드 키 값을 기준으로 하는 연속적인 범위**를 의미하며, MongoDB가 샤드 간에 데이터를 이동시키는 기본 단위입니다.

예를 들어 `userId`를 샤드 키로 사용하는 컬렉션이 있다면, 하나의 청크는 `userId` 1부터 1000까지의 모든 도큐먼트를 포함하는 논리적인 그룹이 될 수 있습니다. MongoDB는 기본적으로 이 청크의 크기가 **128MB**에 도달하면 분할을 고려합니다.

컬렉션을 처음 샤딩하면, 샤드 키의 전체 범위(`minKey` ~ `maxKey`)를 포괄하는 단 하나의 청크로 시작하며, 이 청크는 해당 데이터베이스의 프라이머리 샤드에 위치하게 됩니다.

---

### 청크 분할 (Chunk Splitting): 거대해진 조각 나누기

애플리케이션이 데이터를 계속 삽입함에 따라 특정 청크의 크기가 설정된 청크 크기(기본 128MB)를 초과하게 되면, 해당 청크를 소유한 샤드는 **청크 분할**을 자동으로 트리거합니다.

* **동작 원리:**
    1.  과대해진 청크를 소유한 샤드가 분할 프로세스를 시작합니다.
    2.  이 과정에서 실제 데이터의 이동은 발생하지 않습니다. 단지 기존 청크가 가진 샤드 키의 범위를 거의 동일한 크기의 두 개 범위로 나눕니다. 예를 들어, `userId` 1~1000 범위를 가진 청크는 `1~500`과 `501~1000`의 두 개 청크로 분할됩니다.
    3.  분할이 완료되면, 해당 샤드는 이 새로운 메타데이터 정보(청크 범위가 둘로 나뉘었음)를 **설정 서버(Config Server)에 업데이트**합니다.

청크 분할 자체는 데이터를 이동시키지 않는 매우 빠르고 가벼운 메타데이터 변경 작업입니다. 이는 나중에 밸런서가 데이터를 재분배할 수 있도록 데이터를 더 작은 단위로 미리 준비하는 과정입니다.

---

### 밸런서 (The Balancer): 클러스터의 균형을 맞추는 조율사

**밸런서**는 설정 서버의 프라이머리 노드에서 실행되는 백그라운드 프로세스입니다. 밸런서의 유일한 임무는 클러스터 내 샤드 간의 **청크 개수 차이를 감지하고, 청크를 이동(migration)시켜 데이터 분포를 균등하게** 만드는 것입니다.

* **동작 원리 (청크 마이그레이션):**
    1.  밸런서가 주기적으로 깨어나 각 샤드가 보유한 청크 수를 확인합니다.
    2.  만약 특정 샤드(예: 샤드 A)가 다른 샤드(예: 샤드 B)에 비해 청크를 비정상적으로 많이 가지고 있는 불균형 상태를 감지하면, **청크 마이그레이션**을 시작합니다.
    3.  밸런서는 가장 많은 청크를 가진 샤드 A에서 가장 적은 청크를 가진 샤드 B로 이동할 청크 하나를 선택합니다.
    4.  **이동 과정:**
        a. 샤드 B(목적지)는 샤드 A(소스)로부터 해당 청크의 모든 도큐먼트를 복사하기 시작합니다.
        b. 복사가 진행되는 동안 해당 청크에 대한 모든 쓰기 작업은 여전히 샤드 A로 향하며, 밸런서는 이 변경 내역을 추적합니다.
        c. 초기 복사가 완료되면, 복사 중에 발생한 변경 내역을 샤드 B에 마저 적용합니다.
        d. 마지막으로, 밸런서는 **설정 서버의 메타데이터를 업데이트**하여 해당 청크의 소유자를 샤드 A에서 샤드 B로 변경합니다. 이 작업은 원자적으로 이루어집니다.
    5.  메타데이터 업데이트가 완료되면, `mongos`들은 캐시를 갱신하고 이후 해당 청크 범위에 대한 모든 요청을 샤드 B로 라우팅합니다.
    6.  샤드 A는 이제는 고아가 된 기존 청크 데이터를 안전하게 삭제합니다.

밸런서는 클러스터의 정상적인 애플리케이션 요청에 미치는 영향을 최소화하도록 자동으로 스로틀링(throttling)되며, 매우 안정적으로 데이터 재분배를 수행합니다.

#### 밸런싱 윈도우 (Balancing Window)

밸런서가 동작하는 것 역시 서버에 부하를 유발하므로, 서비스의 최고 트래픽 시간에는 밸런싱을 피하고 싶을 수 있습니다. MongoDB는 **밸런싱 윈도우** 설정을 통해, 밸런서가 활성화될 시간대를 지정할 수 있는 기능을 제공합니다. 예를 들어, "매일 새벽 2시부터 6시 사이에만 밸런싱을 허용한다"와 같이 설정하여 서비스 영향을 최소화할 수 있습니다.

청크 분할과 밸런서는 샤딩 아키텍처가 별도의 관리자 개입 없이도 스스로 데이터를 재분배하고 균형을 유지하는 '자율 운영'의 핵심입니다. 이 자동화된 메커니즘 덕분에 MongoDB 클러스터는 데이터가 증가하거나 새로운 샤드가 추가될 때 매끄럽게 확장될 수 있습니다.