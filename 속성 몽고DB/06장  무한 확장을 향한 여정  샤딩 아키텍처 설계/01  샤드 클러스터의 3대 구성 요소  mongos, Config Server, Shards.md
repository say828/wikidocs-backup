## 01. 샤드 클러스터의 3대 구성 요소: mongos, Config Server, Shards

샤드 클러스터는 단일 프로그램이 아닌, 각각 전문화된 역할을 수행하는 세 가지 핵심 컴포넌트가 유기적으로 협력하여 구성되는 분산 시스템입니다. 이 세 요소의 역할과 상호작용을 이해하는 것이 샤딩 아키텍처의 첫걸음입니다.

이 구조를 하나의 거대한 기업에 비유할 수 있습니다.

* **샤드 (Shards):** 실제 업무를 수행하는 운영 부서들 (영업팀, 개발팀, 마케팅팀 등)
* **설정 서버 (Config Servers):** 조직의 전체 구조와 업무 분장을 기록한 마스터 플랜을 가진 최고 경영진/전략기획실
* **몽고스 (mongos):** 외부의 요청을 받아 마스터 플랜을 보고, 담당 부서에 정확히 연결해주는 안내 데스크/프로젝트 매니저

---

### 샤드 (Shards): 데이터의 실질적인 저장소 🗄️

**샤드**는 전체 데이터의 일부(subset)를 실제로 저장하고 처리하는 핵심 단위입니다. 클러스터의 전체 데이터는 여러 샤드에 나뉘어 저장되며, 각 샤드는 자신이 담당하는 데이터에 대한 모든 읽기/쓰기 요청을 독립적으로 처리합니다.

**가장 중요한 점은, 프로덕션 환경에서 각 샤드는 단일 `mongod` 인스턴스가 아닌, 그 자체로 완벽한 하나의 레플리카 셋(Replica Set)으로 구성되어야 한다는 것입니다.** 이는 샤딩을 통해 **확장성(Scalability)**을 확보하는 동시에, 레플리카 셋을 통해 각 샤드 데이터의 **고가용성(High Availability)**과 **내구성(Durability)**을 보장하기 위함입니다. 만약 샤드 내 프라이머리 노드에 장애가 발생하더라도, 해당 샤드의 세컨더리 노드가 즉시 새로운 프라이머리로 승격되어 서비스 중단을 막아줍니다.



---

### 설정 서버 (Config Servers): 클러스터의 두뇌 🧠

**설정 서버**는 샤드 클러스터의 모든 메타데이터(metadata)를 저장하고 관리하는 중앙 통제 센터입니다. 즉, 애플리케이션 데이터를 직접 저장하지는 않지만, 그 데이터가 **어떤 기준으로 나뉘어 어느 샤드에 저장되어 있는지**에 대한 '지도'를 가지고 있습니다.

* **주요 저장 정보:**
    * 데이터 조각(Chunk)과 샤드 간의 매핑 정보
    * 클러스터에 등록된 모든 샤드의 목록
    * 클러스터의 인증 및 권한 정보

설정 서버는 클러스터의 운영에 있어 너무나 중요하기 때문에, **반드시 3대의 서버로 구성된 레플리카 셋**으로 배포되어야 합니다. 만약 설정 서버가 다운되면, `mongos`가 캐시해 둔 정보를 바탕으로 잠시 동안은 기존의 읽기/쓰기 작업이 가능할 수 있지만, 데이터의 분산이나 이동과 같은 클러스터의 핵심적인 메타데이터 변경 작업이 불가능해져 결국 클러스터 전체가 불안정한 상태에 빠지게 됩니다.

---

### 몽고스 (mongos): 똑똑한 쿼리 라우터 🚦

`mongos`는 애플리케이션과 샤드 클러스터 사이의 인터페이스 역할을 하는 경량의 **쿼리 라우터**입니다. 애플리케이션은 샤드에 직접 연결하는 것이 아니라, 마치 일반적인 단일 `mongod` 서버에 연결하듯 `mongos`에 연결합니다.

* **동작 방식:**
    1.  애플리케이션이 `mongos`로 쿼리를 보냅니다.
    2.  `mongos`는 설정 서버에 질의하여 (또는 캐시된 정보를 사용하여) 쿼리가 필요로 하는 데이터가 어느 샤드에 있는지 확인합니다.
    3.  확인된 샤드(들)에게 쿼리를 정확히 전달합니다.
    4.  여러 샤드로부터 결과를 받으면, 이를 하나로 병합하여 최종 결과를 애플리케이션에 반환합니다.

`mongos` 자체는 상태를 저장하지 않는(stateless) 프로세스이므로, 고가용성과 부하 분산을 위해 여러 대를 동시에 운영할 수 있습니다. 애플리케이션 서버와 동일한 머신에 두거나, 별도의 라우터 서버 풀을 구성하는 것이 일반적입니다. 이처럼 `mongos`는 애플리케이션에게 샤딩의 복잡성을 완전히 숨겨주고, 전체 클러스터를 마치 하나의 거대한 데이터베이스처럼 보이게 만들어주는 투명한 게이트웨이 역할을 수행합니다.

이 세 가지 컴포넌트, 즉 데이터를 저장하는 **샤드**, 지도를 가진 **설정 서버**, 그리고 길을 안내하는 **`mongos`**가 서로 협력하여 MongoDB의 강력하고 확장 가능한 샤딩 아키텍처를 완성합니다. 다음 절에서는 이 아키텍처의 성능을 좌우하는 가장 중요한 결정인 '샤드 키' 선정에 대해 알아보겠습니다.