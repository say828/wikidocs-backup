# 04장: 인덱스: 쿼리 성능의 핵심

지금까지 우리는 데이터를 효율적으로 구조화(1장), 조회(2장), 분석(3장)하는 방법을 배웠습니다. 하지만 아무리 데이터 모델이 훌륭하고 쿼리가 정교하더라도, 데이터베이스가 원하는 데이터를 '빠르게 찾아내지' 못한다면 모든 노력은 수포로 돌아갑니다. 수억 건의 데이터 속에서 단 하나의 도큐먼트를 1초 미만에 찾아내는 마법, 그 비밀은 바로 **인덱스(Index)** 에 있습니다.

이번 장에서는 쿼리 성능을 좌우하는 가장 결정적인 요소인 인덱스의 존재 이유와 내부 동작 원리를 파헤치고, 다양한 비즈니스 시나리오에 맞는 최적의 인덱스를 설계하고 분석하는 실전 기술을 익히게 됩니다.

---

## 00. 인덱스의 존재 이유와 B-Tree 자료 구조

### 인덱스는 왜 필요한가? - 컬렉션 스캔의 비극

인덱스가 없는 컬렉션에 쿼리를 실행하는 것은, 마치 색인(index)이 없는 수천 페이지짜리 기술 서적에서 특정 키워드를 찾는 것과 같습니다. 원하는 내용을 찾기 위한 유일한 방법은 첫 페이지부터 마지막 페이지까지 한 장 한 장 모든 내용을 샅샅이 훑어보는 것뿐입니다.

MongoDB에서도 마찬가지입니다. 인덱스가 없는 쿼리는 **컬렉션 스캔(Collection Scan, COLLSCAN)** 을 수행해야 합니다. 이는 컬렉션에 저장된 **모든 도큐먼트**를 하나씩 메모리로 불러와서 쿼리 조건과 일치하는지 검사하는 방식입니다. 컬렉션에 도큐먼트가 몇천 개 수준이라면 문제가 없겠지만, 수백만, 수억 건으로 늘어난다면 이는 시스템에 엄청난 부하를 주는 재앙적인 작업이 됩니다.

### 인덱스: 데이터로 가는 고속도로

**인덱스**는 이러한 컬렉션 스캔을 피하기 위해 존재하는, 특별한 자료 구조입니다. 책의 맨 뒤에 있는 색인처럼, 인덱스는 특정 필드(또는 필드들의 조합)의 값을 미리 정렬된 상태로 저장하고, 해당 값을 가진 원본 도큐먼트가 디스크 상의 어디에 저장되어 있는지에 대한 **포인터(pointer)** 정보를 함께 유지합니다.

쿼리가 인덱스가 생성된 필드를 조건으로 사용하면, MongoDB는 더 이상 거대한 컬렉션 전체를 뒤지지 않습니다. 대신, 작고 잘 정렬된 인덱스 구조를 먼저 탐색하여 원하는 데이터의 위치를 즉시 알아낸 뒤, 디스크의 해당 위치로 바로 점프하여 도큐먼트를 가져옵니다. 이를 **인덱스 스캔(Index Scan, IXSCAN)** 이라 하며, 컬렉션 스캔에 비해 압도적으로 빠릅니다.

### B-Tree: MongoDB 인덱스의 심장

MongoDB를 포함한 대부분의 현대 데이터베이스는 인덱스를 구현하기 위한 핵심 자료 구조로 **B-Tree(Balanced Tree)** 를 사용합니다. B-Tree는 데이터의 검색, 삽입, 삭제를 모두 효율적으로 처리하도록 특별히 설계된 트리 구조입니다.



B-Tree는 다음과 같은 특징을 가집니다.

1.  **루트(Root)와 리프(Leaf) 노드:** 데이터 탐색은 항상 최상위 노드인 루트에서 시작하여, 여러 단계의 중간(브랜치) 노드를 거쳐 최종적으로 데이터 포인터를 담고 있는 리프 노드에 도달합니다.
2.  **균형(Balanced):** B-Tree는 항상 '균형'을 유지하도록 스스로 조정됩니다. 즉, 루트에서 어떤 리프 노드까지의 거리(트리의 높이)가 항상 거의 동일하게 유지됩니다. 이 특징 덕분에 데이터가 얼마나 많아지든 상관없이, 데이터를 찾는 데 걸리는 시간은 데이터양에 비례하여 선형적으로 증가하는 것이 아니라, **로그 시간($O(\log n)$)** 으로 매우 완만하게 증가합니다. 100만 건에서 10억 건으로 데이터가 늘어나도, 검색 속도는 거의 차이가 없는 놀라운 확장성을 보여줍니다.
3.  **정렬된 데이터:** 가장 하위 레벨인 리프 노드들은 인덱싱된 필드의 값으로 정렬되어 있으며, 각 노드는 서로를 가리키는 포인터를 통해 연결되어 있습니다(doubly linked list). 이 구조 덕분에 `{$gt: 10, $lt: 50}` 과 같은 **범위 쿼리(Range Query)** 가 매우 효율적으로 동작합니다. 시작점(10)을 찾은 뒤, 리프 노드의 연결고리를 따라가기만 하면 되기 때문입니다.

결론적으로, 인덱스는 방대한 데이터 속에서 원하는 정보를 빠르게 찾기 위한 필수적인 도구이며, 그 효율성의 비밀은 바로 B-Tree라는 뛰어난 자료 구조에 있습니다. 다음 절부터는 이 B-Tree를 기반으로 MongoDB가 제공하는 다양한 종류의 인덱스(단일 필드, 복합 필드 등)에 대해 자세히 알아보겠습니다.