## 03. 읽기 설정(Read Preference)의 종류와 활용 시나리오

레플리카 셋은 프라이머리 외에도 여러 개의 데이터 복사본을 가진 세컨더리 노드들로 구성됩니다. 그렇다면 애플리케이션이 데이터를 읽을 때, 반드시 프라이머리에서만 읽어야 할까요? 아니면 세컨더리에서도 읽을 수 있을까요? 이 질문에 대한 답을 제어하는 것이 바로 **읽기 설정(Read Preference)**입니다.

읽기 설정은 MongoDB 드라이버 레벨에서 지정하는 옵션으로, 읽기 작업을 레플리카 셋의 어떤 멤버에게 보낼지(라우팅할지) 결정하는 규칙입니다. 어떤 읽기 설정을 선택하느냐에 따라 애플리케이션의 **읽기 확장성**, **데이터 일관성(최신성)**, 그리고 **가용성**이 달라지므로, 각 기능의 요구사항에 맞는 신중한 선택이 필요합니다.

---

### 읽기 설정의 5가지 모드

#### 1. `primary` (기본값)
* **동작:** 모든 읽기 작업을 예외 없이 **프라이머리** 노드로만 보냅니다.
* **장점:**
    * **강력한 일관성 (Strong Consistency):** 모든 쓰기 작업은 프라이머리에서 처리되므로, 프라이머리에서 읽는 것은 항상 데이터의 가장 최신 버전을 읽는 것을 보장합니다.
* **단점:**
    * **읽기 확장성 부재:** 모든 읽기/쓰기 부하가 프라이머리에 집중되어 병목 현상이 발생할 수 있습니다.
* **활용 시나리오:** **대부분의 애플리케이션에 권장되는 기본 설정입니다.** 특히 사용자 인증, 금융 거래, 주문 처리 등 데이터의 최신성이 매우 중요한 핵심 기능에 반드시 사용해야 합니다.

#### 2. `primaryPreferred`
* **동작:** 평소에는 **프라이머리**에서 읽지만, 프라이머리에 도달할 수 없는 상황(예: 장애 복구 중)일 경우 **세컨더리**에서 대신 읽습니다.
* **장점:**
    * **읽기 가용성 향상:** 선거가 진행되는 짧은 시간 동안에도 읽기 작업이 실패하지 않고 계속될 수 있습니다.
* **단점:**
    * 장애 상황 시, 복제 지연이 있는 세컨더리로부터 오래된(stale) 데이터를 읽을 수 있습니다.
* **활용 시나리오:** 데이터 최신성을 선호하지만, 그보다 읽기 작업의 가용성을 더 중요하게 생각하는 경우에 사용합니다.

#### 3. `secondary`
* **동작:** 모든 읽기 작업을 **세컨더리** 노드 중 하나로 보냅니다. 프라이머리는 이 읽기 요청을 절대 받지 않습니다.
* **장점:**
    * **읽기 확장성:** 읽기 부하를 프라이머리로부터 완전히 분리하여, 프라이머리가 쓰기 작업에만 집중할 수 있게 해줍니다. 분석, 리포팅 등 대량의 읽기 작업에 이상적입니다.
* **단점:**
    * **결과적 일관성 (Eventual Consistency):** 복제 지연으로 인해 오래된 데이터를 읽을 가능성이 항상 존재합니다.
* **활용 시나리오:** 데이터가 약간 지연되어도 괜찮은 기능. BI(Business Intelligence) 대시보드, 야간 통계 배치 작업, 관련 상품 추천 목록 생성 등에 적합합니다.

#### 4. `secondaryPreferred`
* **동작:** 평소에는 **세컨더리**에서 읽지만, 사용 가능한 세컨더리가 하나도 없을 경우 **프라이머리**에서 대신 읽습니다.
* **장점:**
    * **읽기 확장성과 고가용성을 모두 확보**할 수 있는 가장 실용적인 옵션 중 하나입니다.
* **단점:**
    * 평소에는 오래된 데이터를, 세컨더리 장애 시에는 최신 데이터를 읽게 되어 애플리케이션의 동작이 일관되지 않게 느껴질 수 있습니다.
* **활용 시나리오:** 일반적인 웹/모바일 애플리케이션의 백엔드. 읽기 부하를 분산하면서도, 일부 세컨더리 장애에도 읽기 서비스가 중단되지 않도록 하고 싶을 때 가장 널리 사용됩니다.

#### 5. `nearest`
* **동작:** 프라이머리/세컨더리 여부와 상관없이, 애플리케이션 클라이언트로부터 **네트워크 지연 시간(latency)이 가장 짧은** 멤버에서 읽습니다.
* **장점:**
    * **지연 시간 최소화:** 지리적으로 분산된 글로벌 클러스터 환경에서 사용자에게 가장 빠른 응답을 제공할 수 있습니다.
* **단점:**
    * 동작을 예측하기 어렵습니다. 가장 가까운 노드가 프라이머리일 수도, 세컨더리일 수도 있어 일관성 수준이 계속 변할 수 있습니다.
* **활용 시나리오:** 전 세계 각지의 사용자에게 CDN처럼 콘텐츠를 빠르게 제공하는 것이 최우선 목표일 때 사용합니다.

---

### 고급 옵션: `maxStalenessSeconds`

`secondary` 또는 `*Preferred` 모드를 사용할 때, 너무 오래된 데이터를 읽는 것을 방지하기 위한 안전장치입니다. 이 옵션을 `90`으로 설정하면, 드라이버는 프라이머리의 최신 쓰기 시점과 90초 이상 차이가 나지 않는 세컨더리에게만 읽기 요청을 보냅니다. 조건을 만족하는 세컨더리가 없으면 쿼리는 실패합니다.

### 시나리오별 최적의 읽기 설정 전략

| 시나리오 | 추천 Read Preference | 이유 |
| :--- | :--- | :--- |
| **금융 거래, 사용자 인증, 주문 처리** | `primary` | 데이터의 최신성과 강력한 일관성이 무엇보다 중요함. |
| **일반적인 웹/모바일 앱 백엔드 (대시보드, 피드 등)** | `secondaryPreferred` | 읽기 부하를 세컨더리로 분산하여 확장성을 확보하면서도, 세컨더리 장애 시 프라이머리를 통해 읽기 가용성을 보장함. |
| **분석 대시보드, 야간 배치 작업** | `secondary` | 프라이머리에 전혀 영향을 주지 않고 읽기 전용 작업을 수행해야 함. 약간의 데이터 지연은 허용 가능함. |
| **글로벌 서비스의 지역별 콘텐츠 제공** | `nearest` | 전 세계 사용자의 읽기 지연 시간을 최소화하는 것이 최우선 목표. |

어떤 읽기 설정을 사용할 것인가는 정답이 없는 문제입니다. 각 기능의 요구사항을 명확히 분석하고, '일관성', '확장성', '가용성'이라는 세 가지 요소 사이에서 가장 적절한 균형점을 찾는 것이 MongoDB 기반 시스템을 성공적으로 설계하는 핵심 역량입니다.