## 02. 복제 지연(Replication Lag)의 원인과 시스템 영향 분석

레플리카 셋의 복제 메커니즘은 매우 효율적이지만, 기본적으로 비동기(asynchronous) 방식으로 동작합니다. 이는 프라이머리에서의 쓰기 작업과 세컨더리에 해당 작업이 반영되는 시점 사이에 필연적으로 약간의 시간 차이가 발생함을 의미합니다. 이 시간 차이를 **복제 지연(Replication Lag)**이라고 부릅니다.

일반적인 상황에서 복제 지연은 수 밀리초(ms)에 불과하여 거의 감지할 수 없습니다. 하지만 특정 상황에서는 이 지연 시간이 수 초, 심지어 수 분까지 길어질 수 있으며, 이는 시스템의 안정성과 데이터 일관성에 심각한 영향을 미칠 수 있습니다.

---

### 복제 지연의 주요 원인

복제 지연이 발생하는 원인은 크게 세 가지로 나눌 수 있습니다.

#### 1. 네트워크 지연 (Network Latency)
프라이머리와 세컨더리 노드가 물리적으로 멀리 떨어져 있을 때 발생하는 가장 일반적인 원인입니다. 예를 들어, 프라이머리는 한국 서울에, 세컨더리는 미국 버지니아에 위치한 경우, 두 데이터센터 간의 물리적 거리와 네트워크 경로 때문에 Oplog를 전송하고 응답을 받는 데 시간이 걸립니다. 이는 `ping` 시간이 긴 것과 같은 원리입니다.

#### 2. 프라이머리의 과도한 쓰기 부하 (High Write Throughput on Primary)
프라이머리에 단시간에 엄청난 양의 쓰기 요청이 몰리는 경우, 세컨더리가 Oplog을 따라잡는 속도보다 프라이머리가 Oplog을 생성하는 속도가 더 빨라지면서 지연이 발생합니다. 이는 마치 소방 호스에서 뿜어져 나오는 물(프라이머리의 쓰기)을 작은 컵(세컨더리의 처리 능력)으로 받아내는 것과 같습니다.
* **주요 상황:** 대규모 데이터 마이그레이션, 피크 타임의 이벤트 로깅, 대용량 파일 업로드 처리 등.

#### 3. 세컨더리의 리소스 부족 또는 경합 (Resource Contention on Secondary)
가장 간과하기 쉽지만 치명적인 원인입니다. 세컨더리 노드가 복제 작업 외에 다른 무거운 작업을 동시에 처리하고 있을 때 발생합니다.
* **장시간 실행되는 읽기 쿼리:** 분석가나 BI(Business Intelligence) 도구가 세컨더리 노드를 대상으로 매우 복잡하고 오래 걸리는 애그리게이션 쿼리를 실행하면, 해당 쿼리가 CPU나 디스크 I/O 같은 리소스를 독점하게 됩니다. 이로 인해 Oplog을 적용해야 하는 복제 스레드가 리소스를 할당받지 못하고 대기하게 되어 복제 지연이 발생합니다.
* **인덱스 빌드:** 세컨더리 노드에 인덱스를 빌드하는 작업은 상당한 리소스를 소모하므로, 이 시간 동안 복제가 지연될 수 있습니다.
* **백업 작업:** 세컨더리 노드에서 스냅샷 방식의 백업을 수행할 때 디스크 I/O에 부하가 걸려 지연이 발생할 수 있습니다.
* **리소스 부족:** 프라이머리에 비해 세컨더리 노드의 하드웨어 사양(CPU, RAM, 디스크 성능)이 현저히 낮을 경우, 동일한 양의 Oplog을 처리하는 데 더 많은 시간이 걸려 지연이 누적될 수 있습니다.

---

### 복제 지연이 시스템에 미치는 영향

복제 지연은 단순한 '데이터 동기화가 느리다'는 문제를 넘어, 시스템 전체에 다양한 악영향을 미칩니다.

#### 1. 데이터 일관성 문제 (`Stale Reads`)
읽기 요청을 세컨더리로 분산시키는 아키텍처에서, 복제 지연이 심각하다면 애플리케이션은 매우 오래된, **부실한 데이터(Stale Data)**를 읽게 될 수 있습니다.
* **예시:** 사용자가 방금 비밀번호를 변경(프라이머리에 쓰기)한 직후, 프로필 정보를 조회(세컨더리에서 읽기)했는데, 복제 지연 때문에 아직 변경 전의 비밀번호 해시값이 조회되는 상황이 발생할 수 있습니다.

#### 2. 장애 복구 시간 (Failover Time) 증가
프라이머리에 장애가 발생하여 선거를 통해 새로운 프라이머리를 선출해야 할 때, 복제 지연이 심한 세컨더리는 선거에서 이길 자격이 없습니다. 오직 가장 최신 데이터를 가진 노드만이 프라이머리가 될 수 있기 때문입니다. 만약 모든 세컨더리의 복제 지연이 크다면, 새로운 프라이머리가 되기 전에 지연된 Oplog을 모두 따라잡는 데 추가적인 시간이 소요되어, 전체 장애 복구 시간이 길어지고 서비스 중단이 길어집니다.

#### 3. 쓰기 우려 (`w: "majority"`) 실패 가능성
쓰기 우려를 `"majority"`로 설정한 쓰기 작업은 과반수의 노드에 데이터가 복제될 때까지 기다립니다. 만약 복제 지연이 심각하여 세컨더리 노드들이 제시간에 응답하지 못하면, 이 쓰기 작업은 타임아웃 오류를 발생시키며 실패할 수 있습니다. 이는 시스템의 안정성에 직접적인 타격을 줍니다.

#### 4. Oplog 사이즈 초과 위험
Oplog는 크기가 고정된 Capped Collection입니다. 만약 세컨더리가 너무 오랫동안 뒤처져서, 자신이 마지막으로 복제한 지점의 Oplog 항목이 프라이머리에서 이미 새로운 로그에 덮어쓰여 사라져 버린다면, 세컨더리는 더 이상 복제를 이어갈 수 없는 **'낙오(fallen off)' 상태**가 됩니다. 이 경우, 세컨더리는 처음부터 전체 데이터를 다시 복사하는 **초기 동기화(Initial Sync)**를 수행해야만 하며, 이는 매우 시간과 비용이 많이 드는 작업입니다.

복제 지연은 분산 시스템의 건강 상태를 보여주는 핵심적인 지표(metric)입니다. 관리자는 이 지표를 항상 주시해야 하며, 지연이 발생했을 때 그 원인을 신속하게 진단하고 해결하는 능력을 갖추어야 합니다. 다음 절에서는 이러한 복제 지연 상황을 포함하여, 다양한 읽기 요구사항에 대응하기 위한 읽기 설정(Read Preference) 전략에 대해 알아보겠습니다.