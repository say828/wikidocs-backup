# 09장: 프로덕션 환경을 위한 운영 및 안정성 엔지니어링

지금까지 우리는 MongoDB를 사용하여 고성능의 확장 가능한 애플리케이션을 '어떻게 설계하고 구축하는가'에 대한 여정을 걸어왔습니다. 이제 마지막으로, 이렇게 구축된 시스템을 24시간 365일 안정적으로 '어떻게 운영하고 유지하는가'라는, 프로덕션 환경의 가장 중요한 과제에 대해 이야기할 시간입니다.

이번 장에서는 데이터베이스 관리자(DBA)와 사이트 신뢰성 엔지니어(SRE)의 관점에서, 장애를 사전에 예측하고, 문제가 발생했을 때 신속하게 대응하며, 데이터를 안전하게 보호하는 실전 운영 기술들을 다룹니다. 성공적인 시스템은 단지 잘 만들어지는 것을 넘어, 잘 운영될 때 비로소 완성됩니다.

---

## 00. 핵심 성능 지표(Metrics) 모니터링과 해석

> "측정할 수 없는 것은 관리할 수 없다." - 피터 드러커

데이터베이스 운영의 첫걸음은 현재 시스템의 건강 상태를 정확하게 파악하는 것입니다. **모니터링**은 데이터베이스의 다양한 성능 지표(Metrics)를 지속적으로 수집하고 시각화하여, 시스템의 동작을 이해하고 잠재적인 문제를 사전에 식별하는 모든 활동을 의미합니다.

훌륭한 모니터링 시스템은 문제가 터진 뒤에야 허둥지둥 원인을 찾는 '사후 대응'에서 벗어나, 이상 징후를 미리 포착하여 장애가 발생하기 전에 조치를 취하는 **'사전 예방'** 문화를 가능하게 합니다. MongoDB Atlas는 포괄적인 모니터링 대시보드를 기본 제공하며, Datadog, Prometheus/Grafana와 같은 외부 솔루션과 연동하여 더욱 정교한 모니터링 환경을 구축할 수도 있습니다. 사용하는 도구는 다를 수 있지만, 우리가 주시해야 할 핵심 지표는 동일합니다.

### 반드시 주시해야 할 핵심 모니터링 지표

#### 1. 요청 처리량 및 지연 시간 (Throughput & Latency)
* **`opcounters` (초당 연산 수):** `insert`, `query`, `update`, `delete` 등 각 명령어 유형별로 초당 몇 개의 요청을 처리하고 있는지를 나타냅니다. 시스템의 현재 부하 수준을 가장 직접적으로 보여주는 지표입니다.
* **`latency` (연산 지연 시간):** 각 연산이 완료되는 데 걸리는 평균 시간을 밀리초(ms) 단위로 보여줍니다. **사용자 경험과 가장 직결되는 지표**로, 이 수치가 갑자기 급증했다면 시스템에 심각한 문제가 발생했다는 강력한 신호입니다.

#### 2. MongoDB 내부 지표 (Internal Metrics)
* **`queued` (읽기/쓰기 대기열):** 처리되지 못하고 대기 중인 읽기/쓰기 요청의 수. 이 수치가 0 이상으로 꾸준히 유지된다면, 데이터베이스가 현재 처리 용량의 한계에 도달했거나 특정 작업이 락(lock)을 오래 점유하고 있다는 의미입니다.
* **`page_faults_per_sec` (페이지 폴트):** MongoDB가 **메모리(캐시)에서 데이터를 찾지 못하고 디스크에서 데이터를 읽어온 횟수**를 의미합니다. (주의: OS 수준의 페이지 폴트와는 다른 개념입니다.) 이 수치가 지속적으로 높게 나타난다면, 애플리케이션의 워킹셋(working set)이 RAM에 비해 너무 커서 디스크 I/O가 빈번하게 발생하고 있음을 시사합니다. **해결책은 대부분의 경우 RAM 증설입니다.**
* **`cache` (WiredTiger 캐시 활동):** 캐시 내 '더티(dirty)' 데이터의 양이나, 메모리 공간 확보를 위해 '축출(evicted)'되는 페이지의 비율을 보여줍니다. 축출 비율이 높다면 캐시 압박이 심하다는 의미로, 페이지 폴트와 함께 메모리 부족을 진단하는 핵심 지표입니다.
* **`connections` (연결 수):** 현재 데이터베이스에 연결된 클라이언트의 수. 이 수치가 설정된 최대 연결 수에 근접한다면, 커넥션 풀 설정을 확인하거나 서버 용량 증설을 고려해야 합니다.

#### 3. 시스템 리소스 (System Resources)
* **`CPU` 사용률:** CPU가 과도하게 높다면, 비효율적인 쿼리(예: `COLLSCAN`, 인덱스 없는 정렬)가 실행되고 있을 가능성이 높습니다.
* **`Disk I/O` (IOPS):** 디스크의 읽기/쓰기 활동량. 디스크 I/O가 포화 상태라면, 더 빠른 디스크(예: 프로비저닝된 IOPS가 높은 디스크)로 업그레이드하거나, RAM을 늘려 디스크 접근 자체를 줄여야 합니다.

#### 4. 분산 클러스터 지표 (Replication & Sharding Metrics)
* **`replicationLag` (복제 지연):** 레플리카 셋의 프라이머리와 세컨더리 간의 데이터 동기화 지연 시간. 이 수치가 갑자기 증가한다면 세컨더리 노드의 리소스 문제나 네트워크 문제를 의심해야 합니다.
* **`oplog` Window:** Oplog가 저장할 수 있는 시간의 길이. 이 시간이 너무 짧으면, 장애가 발생한 세컨더리가 복구되었을 때 복제를 따라잡지 못하고 초기 동기화를 수행해야 할 위험이 커집니다.
* **`chunks` per shard:** 샤드 클러스터에서 각 샤드가 보유한 청크의 수. 샤드 간 청크 수가 고르지 않다면 밸런서가 제대로 동작하지 않거나 샤드 키 설계에 문제가 있을 수 있습니다.

### 알람(Alerting) 설정의 중요성

모니터링은 단순히 대시보드를 바라보는 행위가 아닙니다. 핵심 지표가 미리 설정된 위험 임계치(threshold)를 넘었을 때, 담당자에게 즉시 알림(이메일, 슬랙, 문자 등)을 보내는 **알람(Alerting)** 체계를 구축하는 것이 중요합니다.

* **예시 알람 규칙:**
    * "복제 지연이 60초 이상 지속될 경우"
    * "쓰기 대기열이 10 이상으로 5분간 유지될 경우"
    * "CPU 사용률이 90%를 초과할 경우"

잘 구축된 모니터링과 알람 시스템은 데이터베이스의 눈과 귀가 되어, 우리가 잠든 사이에도 시스템을 지키고 문제에 선제적으로 대응할 수 있게 해주는 안정성 엔지니어링의 가장 중요한 초석입니다.