# 03장: 애그리게이션 파이프라인: 데이터 통찰의 길

지금까지 우리는 MongoDB 쿼리 언어(MQL)를 사용하여 개별 도큐먼트를 생성, 조회, 수정, 삭제하는 방법을 배웠습니다. 이는 애플리케이션의 핵심 기능을 구현하는 데 필수적입니다. 하지만 데이터의 진정한 가치는 개별 기록들을 모아 의미 있는 통찰력을 발견할 때 드러납니다. "지난달 카테고리별 총매출액은 얼마인가?", "가장 많이 팔린 상품 Top 5는 무엇인가?" 와 같은 비즈니스 질문에 답하려면 여러 도큐먼트를 집계하고 변환하는 과정이 필요합니다.

이러한 데이터 분석 및 리포팅 작업을 위해 MongoDB는 **애그리게이션 프레임워크(Aggregation Framework)** 라는 강력한 도구를 제공합니다. 이번 장에서는 이 프레임워크의 핵심인 파이프라인 패러다임을 이해하고, 다양한 스테이지를 조합하여 원석 같은 데이터로부터 빛나는 보석 같은 정보를 캐내는 기술을 연마하게 될 것입니다.

-----

## 00\. 애그리게이션 프레임워크의 개념과 파이프라인 패러다임

**애그리게이션(Aggregation, 집계)** 이란 여러 도큐먼트의 데이터를 그룹화하고 다양한 연산을 수행하여 계산된 결과를 반환하는 프로세스를 의미합니다. 관계형 데이터베이스의 `GROUP BY` 절과 집계 함수(`SUM`, `AVG`, `COUNT`)를 떠올리면 이해하기 쉽습니다. 하지만 MongoDB의 애그리게이션 프레임워크는 이를 훨씬 뛰어넘는 유연성과 표현력을 제공하며, 그 중심에는 **파이프라인(Pipeline)** 이라는 개념이 있습니다.

### 파이프라인 패러다임: 데이터의 흐름을 조립하다

MongoDB의 애그리게이션 파이프라인은 유닉스/리눅스의 셸(shell) 파이프(`|`)에서 영감을 얻었습니다. 셸에서 한 명령어의 출력이 다음 명령어의 입력으로 연결되는 것처럼, 애그리게이션 파이프라인은 여러 단계의 **스테이지(Stage)** 로 구성되며, 컬렉션의 도큐먼트들이 이 파이프라인을 순서대로 통과하며 점진적으로 변환됩니다.

이 과정을 마치 공장의 조립 라인에 비유할 수 있습니다.

1.  **시작:** 컨베이어 벨트에 원재료(컬렉션의 모든 도큐먼트)가 올라갑니다.
2.  **스테이지 1 (`$match`):** 첫 번째 공정에서 불량 재료(조건에 맞지 않는 도큐먼트)를 걸러냅니다.
3.  **스테이지 2 (`$group`):** 다음 공정에서 걸러진 재료들을 종류별로 묶고(그룹화), 개수를 세거나 무게를 잽니다(집계 연산).
4.  **스테이지 3 (`$sort`):** 마지막 공정에서 완성된 제품들을 무게 순으로 정렬합니다.
5.  **결과:** 최종적으로 정렬된 완제품(최종 결과 도큐먼트)이 라인 끝에서 나옵니다.

### 기본 구조와 장점

애그리게이션 파이프라인은 `db.collection.aggregate()` 메소드를 사용하며, 각 스테이지를 배열의 요소로 전달합니다.

```javascript
db.orders.aggregate([
    { <스테이지 1> },
    { <스테이지 2> },
    { <스테이지 3> },
    // ...
]);
```

이러한 파이프라인 방식은 다음과 같은 강력한 장점을 가집니다.

  * **효율성:** 모든 연산이 데이터가 저장된 데이터베이스 서버 내에서 직접 수행됩니다. 수백만 건의 원본 데이터를 애플리케이션으로 가져와 처리하는 대신, 서버에서 집계된 최종 결과만 받으므로 네트워크 오버헤드가 극적으로 줄어듭니다.
  * **최적화:** MongoDB는 파이프라인을 실행하기 전에 전체 스테이지를 분석하여 최적화 과정을 거칩니다. 예를 들어, 파이프라인 초기에 필터링을 수행하는 `$match` 스테이지가 있다면, 가능한 한 인덱스를 사용하여 처리할 데이터의 양을 조기에 줄임으로써 전체 파이프라인의 성능을 향상시킵니다.
  * **유연성 및 가독성:** 복잡한 데이터 처리 로직을 여러 개의 단순한 스테이지로 분해하여 표현할 수 있으므로, 코드를 이해하고 유지보수하기가 더 쉽습니다.

간단한 예시를 통해 파이프라인의 흐름을 느껴보겠습니다. `orders` 컬렉션에서 "MDB\_MUG\_01" 상품의 총매출액을 계산하는 파이프라인입니다.

```javascript
db.orders.aggregate([
  // 1. "MDB_MUG_01" 상품이 포함된 주문만 필터링
  { $match: { "items.product_id": "MDB_MUG_01" } },

  // 2. 주문에 포함된 상품 배열(items)을 개별 도큐먼트로 분리
  { $unwind: "$items" },

  // 3. 분리된 상품들 중 "MDB_MUG_01"만 다시 필터링
  { $match: { "items.product_id": "MDB_MUG_01" } },

  // 4. 상품별로 그룹화하고, (수량 * 가격)의 합계를 계산
  {
    $group: {
      _id: "$items.product_id",
      totalSales: { $sum: { $multiply: ["$items.quantity", "$items.price"] } }
    }
  }
])
```

위 예시처럼, 각 스테이지는 이전 스테이지의 출력물을 입력으로 받아 명확하게 정의된 한 가지 작업을 수행합니다. 이 스테이지들을 레고 블록처럼 조합하여 우리는 상상할 수 있는 거의 모든 종류의 데이터 분석을 수행할 수 있습니다. 다음 절부터는 이 파이프라인을 구성하는 핵심 스테이지들을 하나씩 자세히 살펴보겠습니다.