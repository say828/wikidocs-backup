## 04. 저널링(Journaling)과 체크포인트(Checkpoint): 데이터 내구성을 위한 최후의 보루

성공적으로 응답을 받은 쓰기 작업이 서버의 갑작스러운 정전이나 OS 크래시 상황에서도 절대 유실되지 않는다는 보장, 즉 **내구성(Durability)**은 모든 데이터베이스 시스템의 가장 근본적인 약속입니다. WiredTiger 스토리지 엔진은 이 약속을 지키기 위해, 비행기의 비행기록장치와 주기적인 안전 점검처럼 이중으로 구성된 정교한 메커니즘을 사용합니다. 바로 **저널링(Journaling)**과 **체크포인트(Checkpoint)**입니다.

---

### 저널링 (Journaling / WAL): 재해 복구를 위한 비행기록장치 ✈️

**저널링**은 데이터베이스에 가해지는 모든 변경 작업을, 실제 데이터 파일에 적용하기에 앞서 별도의 **저널 파일**에 먼저 기록하는 행위입니다. 이는 **WAL(Write-Ahead Log, 선행 로깅)** 이라는 데이터베이스 설계의 표준적인 기법입니다.

* **동작 원리:**
    1.  클라이언트로부터 쓰기 요청(`insert`, `update` 등)이 들어옵니다.
    2.  WiredTiger는 이 변경 작업에 대한 상세한 로그 기록을 생성합니다.
    3.  이 로그 기록을 디스크 상의 **저널 파일**에 추가(append)합니다. 디스크에 순차적으로 기록하는 이 작업은 매우 빠릅니다.
    4.  **저널 파일에 기록이 완료된 것이 확인된 후에야**, 비로소 WiredTiger는 메모리 내의 **내부 캐시**에 있는 데이터를 수정합니다.

**내구성 보장:**
클라이언트가 `writeConcern`을 `{ j: true }`로 설정하여 쓰기를 요청하면, MongoDB는 이 저널 파일 쓰기가 완료될 때까지 기다렸다가 성공을 응답합니다. 즉, 클라이언트가 '성공' 응답을 받았다면, 그 데이터는 최소한 저널 파일이라는 영구적인 저장소에 안전하게 기록되었음이 보장됩니다.

**재해 복구:**
만약 `mongod` 서버가 예기치 않게 다운되었다가 재시작되면, WiredTiger는 가장 먼저 저널 파일을 확인합니다. 그리고 마지막 체크포인트 이후에 기록된 저널 로그들을 순서대로 읽어, 메모리 캐시에 다시 적용(replay)합니다. 이를 통해, 디스크의 주 데이터 파일에는 아직 기록되지 못했던 최근의 모든 변경 사항을 완벽하게 복원하여, 다운 직전의 일관된 데이터 상태로 되돌아갈 수 있습니다.

---

### 체크포인트 (Checkpoint): 메모리와 디스크의 동기화 시점 💾

**체크포인트**는 메모리의 내부 캐시에만 존재하던 '더티(dirty)' 데이터들을, 디스크에 있는 영구적인 **데이터 파일**로 옮겨 적는 주기적인 동기화 작업입니다.

* **동작 원리:**
    1.  기본적으로 60초마다, 또는 저널 파일의 크기가 일정 수준(보통 2GB)에 도달하면 WiredTiger는 체크포인트를 시작합니다.
    2.  내부 캐시에 있는 모든 '더티' 페이지(마지막 체크포인트 이후 변경된 데이터)를 식별합니다.
    3.  이 더티 페이지들을 디스크의 실제 데이터 파일에 일관된 상태로 기록합니다.
    4.  모든 기록이 성공적으로 완료되면, "이 시점까지의 모든 데이터는 영구 데이터 파일에 안전하게 저장되었음"을 나타내는 메타데이터를 기록합니다.

**저널링과의 관계:**
체크포인트는 저널링과 상호 보완적인 관계에 있습니다.
* 체크포인트가 성공적으로 완료되면, 해당 체크포인트 시점 이전에 기록된 저널 파일들은 더 이상 재해 복구를 위해 필요하지 않게 됩니다.
* WiredTiger는 이 오래된 저널 파일들을 안전하게 삭제하여 디스크 공간을 재활용할 수 있습니다.
* 즉, **저널링**은 체크포인트와 체크포인트 사이의 짧은 시간 동안 발생하는 변경 사항에 대한 **단기적인 내구성**을 보장하고, **체크포인트**는 이러한 변경 사항들을 주기적으로 통합하여 **장기적인 영속성**을 제공하고 저널을 정리하는 역할을 합니다.



### 성능에 미치는 영향

* **저널링:** 모든 쓰기 작업에 포함되므로 약간의 지연 시간을 추가합니다. 이 때문에 고성능이 요구되는 시스템에서는 저널 파일이 저장되는 디스크를 데이터 파일이 저장되는 디스크와 물리적으로 분리하여 I/O 경합을 피하는 구성을 고려하기도 합니다.
* **체크포인팅:** 주기적으로 발생하는 I/O 집약적인 작업입니다. 체크포인트가 실행되는 동안 디스크 사용량이 급증하여 다른 쿼리의 성능에 일시적인 영향을 줄 수 있습니다. WiredTiger는 이 부하를 분산시키기 위한 여러 기법을 사용하지만, 쓰기 작업이 매우 많은 시스템에서는 체크포인트 활동이 주요 모니터링 대상이 됩니다.

저널링과 체크포인트는 WiredTiger가 제공하는 데이터 내구성의 양대 축입니다. 이 두 메커니즘의 견고한 협력 덕분에, 우리는 MongoDB에 데이터를 믿고 맡길 수 있습니다. 이로써 MongoDB의 가장 깊은 곳, 스토리지 엔진에 대한 탐구를 마무리합니다.