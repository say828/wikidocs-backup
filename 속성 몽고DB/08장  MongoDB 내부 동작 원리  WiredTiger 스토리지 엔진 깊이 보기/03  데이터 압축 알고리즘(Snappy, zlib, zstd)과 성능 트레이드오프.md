## 03. 데이터 압축 알고리즘(Snappy, zlib, zstd)과 성능 트레이드오프

대규모 데이터를 다루는 현대 데이터베이스에서 저장 공간은 곧 비용입니다. WiredTiger 스토리지 엔진은 데이터를 디스크에 저장하기 전에 투명하게 압축하는 기능을 내장하여, 스토리지 비용을 절감하고 경우에 따라 I/O 성능을 향상시키는 효과를 제공합니다.

하지만 압축에는 공짜가 없습니다. 데이터를 압축하고 해제하는 과정에는 CPU 연산이 필요합니다. 따라서 어떤 압축 알고리즘을 선택하느냐는 **CPU 사용량**과 **디스크 공간/I/O 성능** 사이의 중요한 트레이드오프를 결정하는 행위입니다.

---

### WiredTiger의 압축 메커니즘

WiredTiger는 도큐먼트 하나하나를 개별적으로 압축하지 않습니다. 대신, 디스크에 데이터를 기록할 때 여러 도큐먼트를 모아 **블록(block)** 단위(보통 4KB~32KB)로 구성하고, 이 블록 전체를 압축하여 저장합니다.

* **압축 (쓰기 경로):** 체크포인트가 발생하여 메모리 캐시의 '더티' 데이터가 디스크 데이터 파일에 기록될 때, 데이터 블록은 디스크에 쓰여지기 직전에 압축됩니다. **메모리 캐시 내의 데이터는 항상 압축되지 않은 상태로 유지**되어 빠른 읽기/쓰기 접근을 보장합니다.
* **압축 해제 (읽기 경로):** 쿼리가 캐시에 없는 데이터를 디스크에서 읽어야 할 때(cache miss), WiredTiger는 압축된 블록 전체를 디스크에서 읽어 메모리로 가져온 뒤, 압축을 해제하여 캐시에 적재합니다.

결과적으로, 압축/압축 해제로 인한 CPU 비용은 주로 디스크 I/O가 발생하는 시점, 즉 체크포인트와 캐시 미스 시에 발생합니다. 애플리케이션의 워킹셋이 메모리 캐시에 대부분 상주한다면, 이 CPU 비용은 최소화됩니다.

---

### 압축 알고리즘 비교: Snappy vs. zlib vs. zstd

WiredTiger는 워크로드의 특성에 맞춰 선택할 수 있도록 여러 압축 알고리즘을 제공합니다.

#### 1. Snappy (기본값)
* **특징:** 최고의 압축률보다는 **매우 빠른 압축/압축 해제 속도**에 초점을 맞춰 설계되었습니다. CPU 사용량이 극히 낮아 시스템에 주는 부담이 거의 없습니다.
* **장점:** 적당한 압축률과 압도적인 성능의 균형이 매우 뛰어납니다.
* **용도:** 범용적인 대부분의 워크로드에 적합하며, 어떤 것을 선택해야 할지 확신이 서지 않을 때 가장 안전한 선택입니다. MongoDB의 **기본 압축 알고리즘**인 이유가 있습니다.

#### 2. zlib
* **특징:** 오랫동안 널리 사용되어 온 알고리즘으로, Snappy보다 **훨씬 높은 압축률**을 제공합니다.
* **단점:** 높은 압축률을 얻는 대가로, Snappy에 비해 **상당히 많은 CPU 자원을 소모**합니다.
* **용도:** CPU 자원에 여유가 있고, 디스크 공간 절약이 최우선 목표일 때 적합합니다. 데이터 쓰기 빈도가 낮고 주로 읽기만 발생하는 아카이빙(archiving) 데이터에 적용하면 비용 효율적입니다.

#### 3. zstd (Zstandard)
* **특징:** Facebook에서 개발한 최신 압축 알고리즘입니다. zlib와 비슷하거나 더 나은 압축률을 제공하면서도, CPU 사용량은 Snappy에 근접할 정도로 낮은, **두 마리 토끼를 모두 잡은 알고리즘**으로 평가받습니다.
* **장점:** 성능과 압축률의 '스위트 스팟'을 제공합니다.
* **용도:** MongoDB 4.2부터 지원되며, **대부분의 신규 워크로드에 가장 먼저 고려해볼 만한 강력한 선택지**입니다.

### 성능 트레이드오프와 선택 가이드

| 알고리즘 | 압축률 | CPU 사용량 | 추천 워크로드 | 기본값 여부 |
| :--- | :---: | :---: | :--- | :---: |
| **Snappy** | 낮음 | **매우 낮음** | 범용, CPU에 민감한 워크로드 | **Yes** |
| **zlib** | **높음** | 높음 | 아카이빙, 저장 비용이 최우선인 워크로드 | No |
| **zstd** | 높음 | 낮음 | **대부분의 신규 워크로드**, 성능과 압축률의 균형이 필요할 때 | No |

**선택의 기준:**
* **CPU Bound 워크로드인가?** 애플리케이션의 병목 지점이 CPU라면, CPU 사용량이 가장 낮은 **Snappy**를 고수하는 것이 좋습니다.
* **Storage 비용이 더 중요한가?** 데이터 보관 비용을 최소화해야 하는 아카이브 시스템이라면 **zlib**을 고려할 수 있습니다.
* **둘 다 잡고 싶은가?** 대부분의 현대적인 애플리케이션 환경에서는 **zstd**가 성능에 미치는 영향을 최소화하면서도 상당한 스토리지 절약 효과를 제공하는 가장 균형 잡힌 선택이 될 것입니다.

압축 알고리즘은 `mongod.conf` 설정 파일에서 클러스터 전체의 기본값을 지정하거나, 컬렉션을 생성할 때 개별적으로 지정할 수 있습니다. 이 선택은 데이터베이스 인프라의 총 소유 비용(TCO)과 직결되므로, 워크로드의 특성과 비즈니스의 우선순위를 고려한 신중한 결정이 필요합니다.