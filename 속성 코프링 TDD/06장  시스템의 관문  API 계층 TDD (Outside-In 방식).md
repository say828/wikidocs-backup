# 06장: 시스템의 관문: API 계층 TDD (Outside-In 방식)

지금까지 우리는 아키텍처의 가장 깊은 곳, 즉 도메인 계층에서부터 개발을 시작하여 애플리케이션 계층을 거쳐 인프라스트럭처 계층으로 내려오는 **'Inside-Out'** TDD 방식을 탐험했다. 이는 시스템의 핵심 로직을 견고하게 다지는 데 매우 효과적인 전략이다.

하지만 이제 우리는 관점을 180도 전환할 시간이다. 사용자와 시스템이 처음 만나는 최전선, 바로 **API 엔드포인트**에서부터 개발을 시작하는 **'Outside-In'** TDD 방식을 배워보자. 이 접근법은 마치 건축가가 건물의 외관과 사용자 동선을 먼저 설계한 뒤, 그 설계를 만족시키기 위해 내부 구조와 설비를 채워나가는 것과 같다.

Outside-In TDD는 우리가 만드는 기능이 최종 사용자의 요구사항과 정확히 일치하도록 보장하며, 각 계층이 올바르게 통합되어 동작할 것이라는 강력한 확신을 준다. 이 장에서는 스프링 생태계의 막강한 API 테스트 도구인 **Spring MockMvc**를 활용하여, 시스템의 관문인 API 계층을 TDD로 설계하고 검증하는 모든 기술을 마스터할 것이다.

---

## 00. API 엔드포인트부터 시작하는 TDD: 인수 테스트(Acceptance Test)가 개발을 주도하는 방식

Outside-In TDD의 첫걸음은 **인수 테스트(Acceptance Test)**를 작성하는 것이다. 인수 테스트란, 특정 기능이나 유저 스토리가 "요구사항을 만족하여 인수할 만한 수준인가"를 검증하는 상위 레벨의 테스트를 의미한다. API 계층에서 인수 테스트는 "클라이언트(웹 프론트엔드, 모바일 앱 등)가 우리 API를 올바르게 사용할 수 있는가?"라는 질문에 답하는 것과 같다.

즉, 우리는 서비스나 리포지토리 코드를 한 줄도 작성하기 전에, 다음과 같은 테스트를 먼저 작성한다.

`"HTTP 클라이언트가 /users 경로로 올바른 JSON 데이터를 담아 POST 요청을 보내면, 시스템은 201 Created 상태 코드를 반환하고, 응답 헤더의 Location에 생성된 사용자의 URI가 포함되어야 한다."`

이 테스트는 API의 최종 사용자 관점에서 시스템 전체의 동작을 검증한다. 때문에 테스트 피라미드의 최상단에 위치하며, 컨트롤러, 서비스, 도메인, 영속성 계층까지 아우르는 넓은 범위를 갖는다.

### **이중 루프 TDD (The Double-Loop TDD)**

Outside-In 방식은 종종 '이중 루프' 또는 'Red-Green-Refactor-Red' 사이클로 설명된다.

1.  **바깥쪽 루프 (Acceptance Test):**
    * **RED:** 먼저 전체 기능을 검증하는 큰 단위의 인수 테스트를 작성한다. 예를 들어, `POST /users` 엔드포인트를 테스트한다. 당연히 해당 엔드포인트가 존재하지 않으므로 이 테스트는 실패한다. 이 실패는 우리가 앞으로 만들어야 할 기능의 최종 목표를 설정한다.

2.  **안쪽 루프 (Unit/Integration Tests):**
    * 이제 바깥쪽 루프의 인수 테스트를 통과시키기 위해 필요한 구성요소들을 'Inside-Out' 방식으로 만들어 나간다.
    * **RED:** `UserController`에 대한 단위 테스트를 작성한다. "올바른 요청이 오면 `UserService`의 `register` 메소드를 호출해야 한다"는 테스트다. `register` 메소드가 없으므로 실패한다.
    * **GREEN:** `UserController`에 코드를 작성하여 단위 테스트를 통과시킨다. 이제 컨트롤러는 `UserService`를 필요로 한다.
    * **RED:** `UserService`에 대한 단위 테스트를 작성한다. "사용자 등록 요청을 받으면, `User` 도메인 객체를 생성하고 `UserRepository`에 저장해야 한다"는 테스트다. 실패한다.
    * **GREEN:** `UserService`의 코드를 작성하여 단위 테스트를 통과시킨다.
    * ... 이 과정을 도메인, 리포지토리까지 계속 반복한다.

3.  **다시 바깥쪽 루프로:**
    * **GREEN:** 안쪽 루프에서 모든 구성요소의 단위/통합 테스트가 통과되면, 다시 맨 처음 작성했던 인수 테스트를 실행한다. 모든 조각이 올바르게 맞춰졌으므로, 이제 인수 테스트는 통과해야 한다.
    * **REFACTOR:** 기능 전체를 아우르는 인수 테스트와 각 구성요소를 보호하는 단위 테스트라는 두 개의 안전망 위에서, 코드 전체의 구조와 가독성을 개선하는 리팩토링을 진행한다.

### **Outside-In 방식의 장점**

* **요구사항 중심 개발:** 항상 최종 사용자의 관점에서 개발을 시작하므로, "정말로 필요한 기능만" 만들게 된다. 과잉 설계나 불필요한 기능을 방지한다.
* **통합에 대한 조기 피드백:** 개발 초기부터 각 계층이 어떻게 연결되고 통합되는지를 고민하게 만든다. 이는 개발 막바지에 발생하는 끔찍한 통합 문제를 예방한다.
* **살아있는 API 문서:** 잘 작성된 API 인수 테스트들은 그 자체로 시스템이 제공하는 기능과 사용법을 보여주는 가장 정확하고 항상 최신 상태를 유지하는 문서가 된다.

Outside-In TDD는 기능의 목표를 명확히 하고, 개발 과정의 방향을 제시하는 강력한 나침반이다. 다음 절에서는 이 전략을 실행하기 위한 핵심 도구인 Spring MockMvc의 사용법을 깊이 있게 탐구하여, 실제 HTTP 요청과 응답을 시뮬레이션하는 방법을 배울 것이다.