## 02. CI/CD 파이프라인에 테스트 전략 통합하기: 빌드, 테스트, 배포의 자동화

팀원들이 TDD를 실천하고 페어 프로그래밍으로 지식을 공유하기 시작했다면, 다음 단계는 이 모든 노력이 **자동화된 프로세스**를 통해 일관되게 지켜지도록 보장하는 것이다. 아무리 훌륭한 문화와 규율을 가졌더라도, 인간은 실수를 할 수 있다. "내 컴퓨터에서는 테스트가 다 통과했는데..."라는 변명은 더 이상 통하지 않아야 한다.

**CI/CD (Continuous Integration/Continuous Delivery) 파이프라인**은 TDD 문화가 살아 숨 쉬는 대동맥이다. 이는 단순히 코드를 빌드하고 배포하는 자동화 도구를 넘어, 우리가 이 책에서 배운 모든 테스트 전략을 통합하여 **소프트웨어의 품질을 조직적인 차원에서 강제하는 '품질 게이트(Quality Gate)'** 역할을 수행한다. TDD로 작성된 테스트들은 바로 이 파이프라인 위에서 비로소 진정한 수호자로서의 힘을 발휘한다.

### **단계별 품질 게이트: 효율성과 신뢰도의 균형**

모든 종류의 테스트를 매 커밋마다 실행하는 것은 비효율적이다. 단위 테스트는 수천 개라도 몇 분 안에 끝나지만, 종단간 테스트나 성능 테스트는 실행에 많은 시간과 자원을 소모하기 때문이다. 따라서 현명한 CI/CD 파이프라인은 테스트 피라미드의 원칙에 따라, 빠르고 피드백이 즉각적인 테스트부터 느리지만 신뢰도가 높은 테스트 순으로 여러 단계를 거쳐 품질을 점진적으로 검증한다.

**1단계: 커밋 단계 (Commit Stage) - 개발자의 가장 빠른 피드백 루프**

* **트리거:** 개발자가 자신의 브랜치에 코드를 커밋(push)할 때마다 실행된다.
* **핵심 활동:**
    * **컴파일 및 빌드:** 코드가 문법적으로 올바른지 확인한다.
    * **정적 분석 (Linting):** 코딩 컨벤션을 준수하는지 자동으로 검사한다.
    * **단위 테스트 (Unit Tests):** `FIRST` 원칙을 따르는 수천 개의 단위 테스트를 실행한다. 이 단계는 **1~2분 내**에 끝나야 하며, 개발자에게 가장 즉각적인 피드백을 제공한다.
* **목표:** 코드의 가장 기본적인 논리적 결함을 개발 초기에, 가장 저렴한 비용으로 발견한다. 이 단계에서 실패하면, 코드는 중앙 리포지토리로 통합될 자격조차 없다.

**2단계: 통합 단계 (Integration Stage) - 협력과 계약의 검증**

* **트리거:** 개발자의 브랜치가 주 개발 브랜치(예: `develop` 또는 `main`)에 통합(Pull Request/Merge Request)될 때 실행된다.
* **핵심 활동:**
    * **통합 테스트:** Testcontainers를 활용하여 데이터베이스, 메시지 큐 등 인프라와의 연동을 검증한다.
    * **계약 테스트 (Provider Verification):** Spring Cloud Contract를 통해, 변경된 코드가 소비자(Consumer)들과의 계약을 깨뜨리지 않았는지 검증한다.
* **목표:** 개별 단위들이 올바르게 협력하는지, 그리고 우리 서비스의 변경이 마이크로서비스 생태계 전체에 악영향을 미치지 않는지를 보장한다. 이 단계는 **5~10분 내**에 완료되는 것을 목표로 한다.

**3단계: 인수 및 배포 단계 (Acceptance & Deployment Stage) - 최종 사용자 관점의 검증**

* **트리거:** 통합 단계가 성공적으로 완료된 후, 스테이징(Staging) 또는 프로덕션 환경으로 배포하기 직전에 실행된다.
* **핵심 활동:**
    * **인수 테스트 (API E2E Tests):** Spring MockMvc나 실제 배포된 환경을 대상으로, 주요 사용자 시나리오가 처음부터 끝까지 올바르게 동작하는지 검증한다.
    * **성능 테스트 (Nightly Build):** 매일 밤과 같이 주기적으로 실행되며, k6나 Gatling을 통해 시스템의 핵심 성능 지표가 목표치 이하로 떨어지지 않았는지(Performance Regression) 확인한다.
    * **보안 스캔:** 정적/동적 분석 도구를 사용하여 잠재적인 보안 취약점을 스캔한다.
* **목표:** 최종적으로 배포될 아티팩트가 모든 기능적, 비기능적 요구사항을 만족한다는 최종 승인을 내린다.

이러한 단계별 파이프라인은 개발자에게 **'빌드가 깨지면 모든 것을 멈추고 즉시 해결한다'**는 강력한 규율을 심어준다. CI 파이프라인의 빨간불은 단순한 경고가 아니라, 팀의 품질 기준이 무너졌음을 알리는 비상 사이렌이다. 이 자동화된 품질 게이트가 굳건히 자리 잡았을 때, TDD는 비로소 개인의 노력에서 팀 전체의 약속과 문화로 승화될 수 있다.